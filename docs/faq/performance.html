<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        
        <title>
            
    
    パフォーマンス
 &mdash;
    SQLAlchemy 1.3 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 1.3 Documentation" href="../index.html" />
        <link rel="up" title="よくある質問" href="index.html" />
        <link rel="next" title="セッション/クエリ" href="sessions.html" />
        <link rel="prev" title="ORM設定" href="ormconfiguration.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">1.3.0b1</span>


        | Release Date: unreleased

    </div>

    <h1>SQLAlchemy 1.3 Documentation</h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 1.3 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="よくある質問">よくある質問</a>
        </h3>

        <ul>
<li><span class="link-container first"><a class="reference external" href="connections.html">接続/エンジン</a></span></li>
<li><span class="link-container first"><a class="reference external" href="metadata_schema.html">メタデータ/スキーマ</a></span></li>
<li><span class="link-container first"><a class="reference external" href="sqlexpressions.html">SQL式</a></span></li>
<li><span class="link-container first"><a class="reference external" href="ormconfiguration.html">ORM設定</a></span></li>
<li class="selected"><span class="link-container first"><strong>パフォーマンス</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#how-can-i-profile-a-sqlalchemy-powered-application">SQLAlchemyパワードアプリケーションをプロファイルするにはどうすればよいですか？</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#query-profiling">クエリプロファイリング</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#code-profiling">コードプロファイリング</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#execution-slowness">実行の遅さ</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#result-fetching-slowness-core">結果遅れを取り戻す - コア</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#result-fetching-slowness-orm">結果フェロースローネス -  ORM</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#i-m-inserting-400-000-rows-with-the-orm-and-it-s-really-slow">私はORMで400,000行を挿入していますが、それは本当に遅いです！</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="sessions.html">セッション/クエリ</a></span></li>
</ul>



        </div>

        </div>

    </div>

    

    <div id="docs-body" class="withsidebar" >
        
<div class="section" id="performance">
<span id="faq-performance"></span><h1>パフォーマンス<a class="headerlink" href="#performance" title="このヘッドラインへのパーマリンク">¶</a></h1>
<div class="contents faq local topic" id="id1">
<ul class="simple">
<li><a class="reference internal" href="#how-can-i-profile-a-sqlalchemy-powered-application" id="id2">SQLAlchemyパワードアプリケーションをプロファイルするにはどうすればよいですか？</a><ul>
<li><a class="reference internal" href="#query-profiling" id="id3">クエリプロファイリング</a></li>
<li><a class="reference internal" href="#code-profiling" id="id4">コードプロファイリング</a></li>
<li><a class="reference internal" href="#execution-slowness" id="id5">実行の遅さ</a></li>
<li><a class="reference internal" href="#result-fetching-slowness-core" id="id6">結果遅れを取り戻す - コア</a></li>
<li><a class="reference internal" href="#result-fetching-slowness-orm" id="id7">結果フェロースローネス -  ORM</a></li>
</ul>
</li>
<li><a class="reference internal" href="#i-m-inserting-400-000-rows-with-the-orm-and-it-s-really-slow" id="id8">私はORMで400,000行を挿入していますが、それは本当に遅いです！</a></li>
</ul>
</div>
<div class="section" id="how-can-i-profile-a-sqlalchemy-powered-application">
<span id="faq-how-to-profile"></span><h2>SQLAlchemyパワードアプリケーションをプロファイルするにはどうすればよいですか？<a class="headerlink" href="#how-can-i-profile-a-sqlalchemy-powered-application" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>パフォーマンスの問題を探すには、通常、2つのストーリーが必要です。 1つはクエリプロファイリングで、もう1つはコードプロファイリングです。</p>
<div class="section" id="query-profiling">
<h3>クエリプロファイリング<a class="headerlink" href="#query-profiling" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>時には、単純なSQLのロギング（pythonのロギングモジュールを介して有効にするか、または：func： <cite>.create_engine`の</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>echo = True``引数を介して）は、どれくらいの時間がかかるかを知ることができます。たとえば、SQL操作の直後に何かを記録すると、ログに次のようなものが表示されます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">17</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">48</span><span class="p">,</span><span class="mi">325</span> <span class="n">INFO</span>  <span class="p">[</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Engine</span><span class="o">.</span><span class="mi">0</span><span class="n">x</span><span class="o">...</span><span class="mi">048</span><span class="n">c</span><span class="p">]</span> <span class="n">SELECT</span> <span class="o">...</span>
<span class="mi">17</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">48</span><span class="p">,</span><span class="mi">326</span> <span class="n">INFO</span>  <span class="p">[</span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">base</span><span class="o">.</span><span class="n">Engine</span><span class="o">.</span><span class="mi">0</span><span class="n">x</span><span class="o">...</span><span class="mi">048</span><span class="n">c</span><span class="p">]</span> <span class="p">{</span><span class="o">&lt;</span><span class="n">params</span><span class="o">&gt;</span><span class="p">}</span>
<span class="mi">17</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">48</span><span class="p">,</span><span class="mi">660</span> <span class="n">DEBUG</span> <span class="p">[</span><span class="n">myapp</span><span class="o">.</span><span class="n">somemessage</span><span class="p">]</span></pre></div>
</div>
<p>操作の直後に `` myapp.somemessage``を記録した場合、SQLの部分を完了するのに334msかかりました。</p>
<p>SQLのロギングでは、何十/何百ものクエリーが発行されているかどうかがわかります。 SQLAlchemy ORMを使用すると、部分的に（：func： <cite>.contains_eager（）</cite>）または完全に（：func： <cite>.joinedload（）</cite>、：func： <cite>.subqueryload（） `</cite>）このアクティビティを自動化しますが、ORM &amp;quot;eager loading &amp;quot;を使わないと通常はジョインを使用するので、複数のテーブルの結果を深度が追加されたときに複数のクエリを掛ける代わりに1つの結果セットにロードできます+ r * r2 + r * r2 * r3`` ...）</p>
<p>問合せの長期的なプロファイリングや、アプリケーション側の「スロー・クエリー」モニターの実装では、次のようなレシピを使用してイベントを使用してカーソルの実行を傍受することができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">event</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.engine</span> <span class="k">import</span> <span class="n">Engine</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">logging</span>

<span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">()</span>
<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;myapp.sqltime&quot;</span><span class="p">)</span>
<span class="n">logger</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="n">logging</span><span class="o">.</span><span class="n">DEBUG</span><span class="p">)</span>

<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s2">&quot;before_cursor_execute&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">before_cursor_execute</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span>
                        <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">executemany</span><span class="p">):</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">info</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;query_start_time&#39;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">())</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Start Query: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">statement</span><span class="p">)</span>

<span class="nd">@event</span><span class="o">.</span><span class="n">listens_for</span><span class="p">(</span><span class="n">Engine</span><span class="p">,</span> <span class="s2">&quot;after_cursor_execute&quot;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">after_cursor_execute</span><span class="p">(</span><span class="n">conn</span><span class="p">,</span> <span class="n">cursor</span><span class="p">,</span> <span class="n">statement</span><span class="p">,</span>
                        <span class="n">parameters</span><span class="p">,</span> <span class="n">context</span><span class="p">,</span> <span class="n">executemany</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">conn</span><span class="o">.</span><span class="n">info</span><span class="p">[</span><span class="s1">&#39;query_start_time&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Query Complete!&quot;</span><span class="p">)</span>
    <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Total Time: </span><span class="si">%f</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">total</span><span class="p">)</span></pre></div>
</div>
<p>上記では、ステートメントが実行されたときにインターセプトポイントを設定するために、：meth： <cite>.ConnectionEvents.before_cursor_execute`と：meth：</cite> .ConnectionEvents.after_cursor_execute`イベントを使用します。 ：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>._ConnectionRecord.info`ディクショナリを使用してタイマーを接続に追加します。カーソルの実行イベントが入れ子になっている場合があるため、ここではスタックを使用します。</p>
</div>
<div class="section" id="code-profiling">
<h3>コードプロファイリング<a class="headerlink" href="#code-profiling" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ロギングで個々のクエリが長すぎると判明した場合は、データベース内でクエリを処理し、ネットワーク経由で結果を送信し、：term： &amp;#39;DBAPI&amp;#39;によって処理された時間を分析し、最後にSQLAlchemyの結果セットおよび/またはORMレイヤーによって受け取られます。これらの段階のそれぞれは、詳細に応じて独自のボトルネックを提示することができます。</p>
<p>そのためには、 <a href="#id1"><span class="problematic" id="id2">`</span></a>Pythonプロファイリングモジュール&lt;<a class="reference external" href="https://docs.python.org/2/library/profile.html">https://docs.python.org/2/library/profile.html</a>&gt; <a href="#id3"><span class="problematic" id="id4">`</span></a>_。以下は、コンテキストマネージャにプロファイリングする簡単なレシピです：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">cProfile</span>
<span class="kn">import</span> <span class="nn">StringIO</span>
<span class="kn">import</span> <span class="nn">pstats</span>
<span class="kn">import</span> <span class="nn">contextlib</span>

<span class="nd">@contextlib</span><span class="o">.</span><span class="n">contextmanager</span>
<span class="k">def</span> <span class="nf">profiled</span><span class="p">():</span>
    <span class="n">pr</span> <span class="o">=</span> <span class="n">cProfile</span><span class="o">.</span><span class="n">Profile</span><span class="p">()</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">enable</span><span class="p">()</span>
    <span class="k">yield</span>
    <span class="n">pr</span><span class="o">.</span><span class="n">disable</span><span class="p">()</span>
    <span class="n">s</span> <span class="o">=</span> <span class="n">StringIO</span><span class="o">.</span><span class="n">StringIO</span><span class="p">()</span>
    <span class="n">ps</span> <span class="o">=</span> <span class="n">pstats</span><span class="o">.</span><span class="n">Stats</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">s</span><span class="p">)</span><span class="o">.</span><span class="n">sort_stats</span><span class="p">(</span><span class="s1">&#39;cumulative&#39;</span><span class="p">)</span>
    <span class="n">ps</span><span class="o">.</span><span class="n">print_stats</span><span class="p">()</span>
    <span class="c1"># uncomment this to see who&#39;s calling what</span>
    <span class="c1"># ps.print_callers()</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">getvalue</span><span class="p">())</span></pre></div>
</div>
<p>コードセクションをプロファイルする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">profiled</span><span class="p">():</span>
    <span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">FooClass</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">FooClass</span><span class="o">.</span><span class="n">somevalue</span><span class="o">==</span><span class="mi">8</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span></pre></div>
</div>
<p>プロファイリングの出力を使用して、時間が費やされている場所を知ることができます。プロファイリング出力のセクションは次のようになります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">13726</span> <span class="n">function</span> <span class="n">calls</span> <span class="p">(</span><span class="mi">13042</span> <span class="n">primitive</span> <span class="n">calls</span><span class="p">)</span> <span class="ow">in</span> <span class="mf">0.014</span> <span class="n">seconds</span>

<span class="n">Ordered</span> <span class="n">by</span><span class="p">:</span> <span class="n">cumulative</span> <span class="n">time</span>

<span class="n">ncalls</span>  <span class="n">tottime</span>  <span class="n">percall</span>  <span class="n">cumtime</span>  <span class="n">percall</span> <span class="n">filename</span><span class="p">:</span><span class="n">lineno</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
<span class="mi">222</span><span class="o">/</span><span class="mi">21</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>    <span class="mf">0.011</span>    <span class="mf">0.001</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">loading</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">26</span><span class="p">(</span><span class="n">instances</span><span class="p">)</span>
<span class="mi">220</span><span class="o">/</span><span class="mi">20</span>    <span class="mf">0.002</span>    <span class="mf">0.000</span>    <span class="mf">0.010</span>    <span class="mf">0.001</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">loading</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">327</span><span class="p">(</span><span class="n">_instance</span><span class="p">)</span>
<span class="mi">220</span><span class="o">/</span><span class="mi">20</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.010</span>    <span class="mf">0.000</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">loading</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">284</span><span class="p">(</span><span class="n">populate_state</span><span class="p">)</span>
   <span class="mi">20</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.010</span>    <span class="mf">0.000</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">strategies</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">987</span><span class="p">(</span><span class="n">load_collection_from_subq</span><span class="p">)</span>
   <span class="mi">20</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.009</span>    <span class="mf">0.000</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">strategies</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">935</span><span class="p">(</span><span class="n">get</span><span class="p">)</span>
    <span class="mi">1</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.009</span>    <span class="mf">0.009</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">strategies</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">940</span><span class="p">(</span><span class="n">_load</span><span class="p">)</span>
   <span class="mi">21</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.008</span>    <span class="mf">0.000</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">strategies</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">942</span><span class="p">(</span><span class="o">&lt;</span><span class="n">genexpr</span><span class="o">&gt;</span><span class="p">)</span>
    <span class="mi">2</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.004</span>    <span class="mf">0.002</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">query</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2400</span><span class="p">(</span><span class="fm">__iter__</span><span class="p">)</span>
    <span class="mi">2</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.002</span>    <span class="mf">0.001</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">query</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">2414</span><span class="p">(</span><span class="n">_execute_and_instances</span><span class="p">)</span>
    <span class="mi">2</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.002</span>    <span class="mf">0.001</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">engine</span><span class="o">/</span><span class="n">base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">659</span><span class="p">(</span><span class="n">execute</span><span class="p">)</span>
    <span class="mi">2</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.002</span>    <span class="mf">0.001</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">sql</span><span class="o">/</span><span class="n">elements</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">321</span><span class="p">(</span><span class="n">_execute_on_connection</span><span class="p">)</span>
    <span class="mi">2</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.002</span>    <span class="mf">0.001</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">engine</span><span class="o">/</span><span class="n">base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">788</span><span class="p">(</span><span class="n">_execute_clauseelement</span><span class="p">)</span>

<span class="o">...</span></pre></div>
</div>
<p>上の例では、 `` instances（） `` SQLAlchemy関数が222回（再帰的に、そして外部から21回）呼び出され、すべての呼び出しが合計で.011秒となりました。</p>
</div>
<div class="section" id="execution-slowness">
<h3>実行の遅さ<a class="headerlink" href="#execution-slowness" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>これらの呼び出しの詳細は、時間がどこに費やされているかを示すことができます。例えば、 `` cursor.execute（） <a href="#id1"><span class="problematic" id="id2">``</span></a>の中で時間が費やされているとしたら、DBAPI</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>    <span class="mf">0.102</span>    <span class="mf">0.102</span>    <span class="mf">0.204</span>    <span class="mf">0.102</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;execute&#39;</span> <span class="n">of</span> <span class="s1">&#39;sqlite3.Cursor&#39;</span> <span class="n">objects</span><span class="p">}</span></pre></div>
</div>
<p>これは、結果が返されるまでにデータベースが長時間を要していることを示しています。つまり、インデックスを追加したり、クエリや基本スキーマを再構成したりすることによって、クエリを最適化する必要があります。このタスクでは、データベースバックエンドによって提供されるように、EXPLAIN、SHOW PLANなどのシステムを使用して、クエリプランの分析が保証されます。</p>
</div>
<div class="section" id="result-fetching-slowness-core">
<h3>結果遅れを取り戻す - コア<a class="headerlink" href="#result-fetching-slowness-core" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>一方、行をフェッチすることに関連して何千もの呼び出しがあったり、 `` fetchall（） <a href="#id1"><span class="problematic" id="id2">``</span></a>の呼び出しが非常に長い場合、クエリが予想よりも多くの行を返しているか、行自体のフェッチが遅い。 ORM自体は通常、行をフェッチするために `` fetchall（） <a href="#id3"><span class="problematic" id="id4">``</span></a>を使用します。：meth： <cite>.Query.yield_per`オプションが使用されている場合は</cite> <cite>fetchmany（）</cite> <a href="#id5"><span class="problematic" id="id6">`</span></a>です。</p>
<p>DBAPIレベルで `` fetchall（） <a href="#id1"><span class="problematic" id="id2">``</span></a>を呼び出すのが非常に遅いことで、異常に多くの行が表示されます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">2</span>    <span class="mf">0.300</span>    <span class="mf">0.600</span>    <span class="mf">0.300</span>    <span class="mf">0.600</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;fetchall&#39;</span> <span class="n">of</span> <span class="s1">&#39;sqlite3.Cursor&#39;</span> <span class="n">objects</span><span class="p">}</span></pre></div>
</div>
<p>たとえ最終的な結果が多数の行を持たないように見える場合でも、予想外に多数の行は、複数の行セットが適切に結合されずに結合されているデカルト積の結果である可能性があります。間違った：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Column`オブジェクトが複雑なクエリで使用され、予期せぬ追加のFROM句が引き出された場合、SQLAlchemy CoreまたはORMクエリでこの動作を生成することはしばしば簡単です。</p>
<p>一方、DBAPIレベルでの `` fetchall（） <a href="#id1"><span class="problematic" id="id2">``</span></a>への高速呼び出しは、SQLAlchemyの：class： <cite>.ResultProxy`が</cite> <cite>fetchall（）</cite> <a href="#id3"><span class="problematic" id="id4">`</span></a>を実行するように要求されたときに遅くなります。ユニコード変換などのデータ型の処理:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># the DBAPI cursor is fast...</span>
<span class="mi">2</span>    <span class="mf">0.020</span>    <span class="mf">0.040</span>    <span class="mf">0.020</span>    <span class="mf">0.040</span> <span class="p">{</span><span class="n">method</span> <span class="s1">&#39;fetchall&#39;</span> <span class="n">of</span> <span class="s1">&#39;sqlite3.Cursor&#39;</span> <span class="n">objects</span><span class="p">}</span>

<span class="o">...</span>

<span class="c1"># but SQLAlchemy&#39;s result proxy is slow, this is type-level processing</span>
<span class="mi">2</span>    <span class="mf">0.100</span>    <span class="mf">0.200</span>    <span class="mf">0.100</span>    <span class="mf">0.200</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">engine</span><span class="o">/</span><span class="n">result</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">778</span><span class="p">(</span><span class="n">fetchall</span><span class="p">)</span></pre></div>
</div>
<p>場合によっては、バックエンドが必要とされないタイプレベルの処理を行っている可能性があります。より具体的には、タイプAPI内で遅い呼び出しを確認する方が良い指標です。以下のような型を使用すると、次のようになります。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">TypeDecorator</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="k">class</span> <span class="nc">Foo</span><span class="p">(</span><span class="n">TypeDecorator</span><span class="p">):</span>
    <span class="n">impl</span> <span class="o">=</span> <span class="n">String</span>

    <span class="k">def</span> <span class="nf">process_result_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">thing</span><span class="p">):</span>
        <span class="c1"># intentionally add slowness for illustration purposes</span>
        <span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">(</span><span class="o">.</span><span class="mi">001</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">value</span></pre></div>
</div>
<p>この意図的に遅い操作のプロファイリング出力は次のように見ることができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mi">200</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>    <span class="mf">0.237</span>    <span class="mf">0.001</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">sql</span><span class="o">/</span><span class="n">type_api</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">911</span><span class="p">(</span><span class="n">process</span><span class="p">)</span>
<span class="mi">200</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>    <span class="mf">0.236</span>    <span class="mf">0.001</span> <span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">28</span><span class="p">(</span><span class="n">process_result_value</span><span class="p">)</span>
<span class="mi">200</span>    <span class="mf">0.235</span>    <span class="mf">0.001</span>    <span class="mf">0.235</span>    <span class="mf">0.001</span> <span class="p">{</span><span class="n">time</span><span class="o">.</span><span class="n">sleep</span><span class="p">}</span></pre></div>
</div>
<p>つまり、 `` type_api``システム内では多くの高価な呼び出しがあり、実際に時間がかかるのは `` time.sleep（） <a href="#id1"><span class="problematic" id="id2">``</span></a>の呼び出しです。</p>
<p>：doc： <a href="#id1"><span class="problematic" id="id2">`</span></a>Dialect documentationを確認してください&lt;dialects/index&gt; <a href="#id3"><span class="problematic" id="id4">`</span></a>このレベルでの既知のパフォーマンスチューニングの提案、特にOracleのようなデータベースに関する注意事項。すべての場合に必要とされない数値精度または文字列処理を保証することに関連するシステムが存在する可能性があります。</p>
<p>ローフェッチのパフォーマンスが低下しているさらに低レベルのポイントがあるかもしれません。例えば、 `` socket.receive（） <a href="#id1"><span class="problematic" id="id2">``</span></a>のような呼び出しに時間が費やされているようであれば、実際のネットワーク接続を除いてすべてが速いことを示している可能性があります。</p>
</div>
<div class="section" id="result-fetching-slowness-orm">
<h3>結果フェロースローネス -  ORM<a class="headerlink" href="#result-fetching-slowness-orm" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>`` populate_state（） <a href="#id1"><span class="problematic" id="id2">``</span></a>と `` _instance（） <a href="#id3"><span class="problematic" id="id4">``</span></a>のような呼び出しは、個々のORMオブジェクトの母集団を示しています::パフォーマンスの問題の最も一般的な領域である行のORMフェッチの遅さを検出するには、</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># the ORM calls _instance for each ORM-loaded row it sees, and</span>
<span class="c1"># populate_state for each ORM-loaded row that results in the population</span>
<span class="c1"># of an object&#39;s attributes</span>
<span class="mi">220</span><span class="o">/</span><span class="mi">20</span>    <span class="mf">0.001</span>    <span class="mf">0.000</span>    <span class="mf">0.010</span>    <span class="mf">0.000</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">loading</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">327</span><span class="p">(</span><span class="n">_instance</span><span class="p">)</span>
<span class="mi">220</span><span class="o">/</span><span class="mi">20</span>    <span class="mf">0.000</span>    <span class="mf">0.000</span>    <span class="mf">0.009</span>    <span class="mf">0.000</span> <span class="n">lib</span><span class="o">/</span><span class="n">sqlalchemy</span><span class="o">/</span><span class="n">orm</span><span class="o">/</span><span class="n">loading</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">284</span><span class="p">(</span><span class="n">populate_state</span><span class="p">)</span></pre></div>
</div>
<p>行をORMでマップされたオブジェクトに変換する際のORMの遅さは、この操作の複雑さとcPythonのオーバーヘッドを組み合わせたものです。これを軽減するための一般的な戦略は次のとおりです。</p>
<ul>
<li><p class="first">完全なエンティティの代わりに個々の列をフェッチする：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div>
</div>
<p>の代わりに：：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p class="first">：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Bundle`オブジェクトを使用してカラムベースの結果を整理する:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">u_b</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">(</span><span class="s1">&#39;user&#39;</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<span class="n">a_b</span> <span class="o">=</span> <span class="n">Bundle</span><span class="p">(</span><span class="s1">&#39;address&#39;</span><span class="p">,</span> <span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">Address</span><span class="o">.</span><span class="n">email</span><span class="p">)</span>

<span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">u_b</span><span class="p">,</span> <span class="n">a_b</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">):</span>
    <span class="c1"># ...</span></pre></div>
</div>
</li>
<li><p class="first">結果のキャッシングを使用してください：詳細は、：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>examples_caching`を参照してください。</p>
</li>
<li><p class="first">Pypyのようなより速い通訳を考えてみましょう。</p>
</li>
</ul>
<p>プロファイルの出力は少し難しいかもしれませんが、いくつかの練習の後、読みやすくなります。</p>
<div class="admonition seealso">
<p class="first admonition-title">参考</p>
<p class="last">：ref： <cite>examples_performance</cite>  - バンドルされたプロファイリング機能を備えたパフォーマンスデモのスイートです。</p>
</div>
</div>
</div>
<div class="section" id="i-m-inserting-400-000-rows-with-the-orm-and-it-s-really-slow">
<h2>私はORMで400,000行を挿入していますが、それは本当に遅いです！<a class="headerlink" href="#i-m-inserting-400-000-rows-with-the-orm-and-it-s-really-slow" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>SQLAlchemy ORMは、変更をデータベースに同期させるときに：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>作業単位 &amp;#39;パターンを使用します。このパターンは、データの単純な「挿入」をはるかに超えています。オブジェクトに割り当てられた属性は、オブジェクトが作成されたときの変更を追跡する属性計装システムを使用して受け取られます。挿入されたすべての行がIDマップで追跡され、各行に対してSQLAlchemyが&amp;quot;最後に挿入されたID&amp;quot;がまだ与えられていない場合は、挿入される行もスキャンされ、必要に応じて依存関係がソートされます。オブジェクトはまた、これをすべて実行するためにかなりの簿記の対象となります。非常に多数の行については、大量のデータ構造に費やす時間が過度に長くなる可能性があります。</p>
<p>基本的に、作業単位は、複雑なオブジェクト・グラフを明示的な永続コードなしでリレーショナル・データベースに永続化する作業を自動化するために、大規模な自動化であり、この自動化には価格があります。</p>
<p>ORMは、基本的に高性能なバルク挿入を目的としたものではありません。これは、SQLAlchemyがORMに加えてCoreも第一級のコンポーネントとして提供している理由のすべてです。</p>
<p>高速バルク挿入の使用の場合、ORMがビルドするSQL生成および実行システムは、以下のようになります。doc： <a href="#id1"><span class="problematic" id="id2">`</span></a>Core &lt;core/tutorial&gt; <a href="#id3"><span class="problematic" id="id4">`</span></a>。このシステムを直接使用することで、生のデータベースAPIを直接使用することと競合するINSERTを生成することができます。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">psycopg2方言を使うときは、：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>バッチ実行ヘルパー&lt;psycopg2_batch_mode&gt; <a href="#id3"><span class="problematic" id="id4">`</span></a>psycopg2の機能は、SQLAlchemy psycopg2方言で直接サポートされています。</p>
</div>
<p>代わりに、SQLAlchemy ORMは：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>bulk_operations`メソッド群を提供します。これは、ORMベースの自動化の程度が小さいコアレベルのINSERTおよびUPDATE構文を生成するために、作業単位のサブセクションにフックを提供します。</p>
<p>以下の例は、最も自動化されたものから最小のものへと、行を挿入するいくつかの異なるメソッドの時間ベースのテストを示しています。 cPython 2.7では、ランタイムが観察されました:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SQLAlchemy</span> <span class="n">ORM</span><span class="p">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">6.89754080772</span> <span class="n">secs</span>
<span class="n">SQLAlchemy</span> <span class="n">ORM</span> <span class="n">pk</span> <span class="n">given</span><span class="p">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">4.09481811523</span> <span class="n">secs</span>
<span class="n">SQLAlchemy</span> <span class="n">ORM</span> <span class="n">bulk_save_objects</span><span class="p">():</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">1.65821218491</span> <span class="n">secs</span>
<span class="n">SQLAlchemy</span> <span class="n">ORM</span> <span class="n">bulk_insert_mappings</span><span class="p">():</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">0.466513156891</span> <span class="n">secs</span>
<span class="n">SQLAlchemy</span> <span class="n">Core</span><span class="p">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">0.21024107933</span> <span class="n">secs</span>
<span class="n">sqlite3</span><span class="p">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">0.137335062027</span> <span class="n">sec</span></pre></div>
</div>
<p>最近のバージョンの <a href="#id1"><span class="problematic" id="id2">`</span></a>Pypy &amp;#39;を使って、時間を3倍近く減らすことができます&lt;<a class="reference external" href="http://pypy.org/">http://pypy.org/</a>&gt; <a href="#id3"><span class="problematic" id="id4">`</span></a>_</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SQLAlchemy</span> <span class="n">ORM</span><span class="p">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">2.39429616928</span> <span class="n">secs</span>
<span class="n">SQLAlchemy</span> <span class="n">ORM</span> <span class="n">pk</span> <span class="n">given</span><span class="p">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">1.51412987709</span> <span class="n">secs</span>
<span class="n">SQLAlchemy</span> <span class="n">ORM</span> <span class="n">bulk_save_objects</span><span class="p">():</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">0.568987131119</span> <span class="n">secs</span>
<span class="n">SQLAlchemy</span> <span class="n">ORM</span> <span class="n">bulk_insert_mappings</span><span class="p">():</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">0.320806980133</span> <span class="n">secs</span>
<span class="n">SQLAlchemy</span> <span class="n">Core</span><span class="p">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">0.206904888153</span> <span class="n">secs</span>
<span class="n">sqlite3</span><span class="p">:</span> <span class="n">Total</span> <span class="n">time</span> <span class="k">for</span> <span class="mi">100000</span> <span class="n">records</span> <span class="mf">0.165791988373</span> <span class="n">sec</span></pre></div>
</div>
<p>スクリプト：：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>

<span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span>  <span class="n">create_engine</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">scoped_session</span><span class="p">,</span> <span class="n">sessionmaker</span>

<span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span>
<span class="n">DBSession</span> <span class="o">=</span> <span class="n">scoped_session</span><span class="p">(</span><span class="n">sessionmaker</span><span class="p">())</span>
<span class="n">engine</span> <span class="o">=</span> <span class="kc">None</span>


<span class="k">class</span> <span class="nc">Customer</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s2">&quot;customer&quot;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">))</span>


<span class="k">def</span> <span class="nf">init_sqlalchemy</span><span class="p">(</span><span class="n">dbname</span><span class="o">=</span><span class="s1">&#39;sqlite:///sqlalchemy.db&#39;</span><span class="p">):</span>
    <span class="k">global</span> <span class="n">engine</span>
    <span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="n">dbname</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">remove</span><span class="p">()</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">,</span> <span class="n">autoflush</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">expire_on_commit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">drop_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
    <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_orm</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">()</span>
        <span class="n">customer</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;NAME &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">DBSession</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy ORM: Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_orm_pk_given</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">customer</span> <span class="o">=</span> <span class="n">Customer</span><span class="p">(</span><span class="nb">id</span><span class="o">=</span><span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;NAME &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">customer</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">%</span> <span class="mi">1000</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">DBSession</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy ORM pk given: Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_orm_bulk_save_objects</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">bulk_save_objects</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">Customer</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;NAME &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">chunk</span> <span class="o">+</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy ORM bulk_save_objects(): Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_orm_bulk_insert</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">chunk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">n</span><span class="p">,</span> <span class="mi">10000</span><span class="p">):</span>
        <span class="n">DBSession</span><span class="o">.</span><span class="n">bulk_insert_mappings</span><span class="p">(</span>
            <span class="n">Customer</span><span class="p">,</span>
            <span class="p">[</span>
                <span class="nb">dict</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;NAME &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">chunk</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="n">chunk</span> <span class="o">+</span> <span class="mi">10000</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
            <span class="p">]</span>
        <span class="p">)</span>
    <span class="n">DBSession</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy ORM bulk_insert_mappings(): Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">test_sqlalchemy_core</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">):</span>
    <span class="n">init_sqlalchemy</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">engine</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="n">Customer</span><span class="o">.</span><span class="n">__table__</span><span class="o">.</span><span class="n">insert</span><span class="p">(),</span>
        <span class="p">[{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="s1">&#39;NAME &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)}</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">)]</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;SQLAlchemy Core: Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; secs&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">init_sqlite3</span><span class="p">(</span><span class="n">dbname</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DROP TABLE IF EXISTS customer&quot;</span><span class="p">)</span>
    <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
        <span class="s2">&quot;CREATE TABLE customer (id INTEGER NOT NULL, &quot;</span>
        <span class="s2">&quot;name VARCHAR(255), PRIMARY KEY(id))&quot;</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="k">return</span> <span class="n">conn</span>


<span class="k">def</span> <span class="nf">test_sqlite3</span><span class="p">(</span><span class="n">n</span><span class="o">=</span><span class="mi">100000</span><span class="p">,</span> <span class="n">dbname</span><span class="o">=</span><span class="s1">&#39;sqlite3.db&#39;</span><span class="p">):</span>
    <span class="n">conn</span> <span class="o">=</span> <span class="n">init_sqlite3</span><span class="p">(</span><span class="n">dbname</span><span class="p">)</span>
    <span class="n">c</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">()</span>
    <span class="n">t0</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">xrange</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
        <span class="n">row</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;NAME &#39;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">),)</span>
        <span class="n">c</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;INSERT INTO customer (name) VALUES (?)&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
    <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;sqlite3: Total time for &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">n</span><span class="p">)</span> <span class="o">+</span>
        <span class="s2">&quot; records &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span> <span class="o">-</span> <span class="n">t0</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; sec&quot;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">test_sqlalchemy_orm</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlalchemy_orm_pk_given</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlalchemy_orm_bulk_save_objects</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlalchemy_orm_bulk_insert</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlalchemy_core</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span>
    <span class="n">test_sqlite3</span><span class="p">(</span><span class="mi">100000</span><span class="p">)</span></pre></div>
</div>
</div>
</div>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="ormconfiguration.html" title="previous chapter">ORM設定</a>
        Next:
        <a href="sessions.html" title="next chapter">セッション/クエリ</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2018, the SQLAlchemy authors and contributors.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.8.1.
    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.3.0b1',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


