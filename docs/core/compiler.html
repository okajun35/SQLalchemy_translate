<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        
        <title>
            
    
    カスタムSQLコンストラクトとコンパイル拡張
 &mdash;
    SQLAlchemy 1.3 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 1.3 Documentation" href="../index.html" />
        <link rel="up" title="SQL Statements and Expressions API(SQL文とAPI式)" href="expression_api.html" />
        <link rel="next" title="式シリアライザ拡張" href="serializer.html" />
        <link rel="prev" title="SQLと汎用関数" href="functions.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">1.3.0b1</span>


        | Release Date: unreleased

    </div>

    <h1>SQLAlchemy 1.3 Documentation</h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 1.3 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemyコア">SQLAlchemyコア</a>
        </h3>

        <ul>
<li><span class="link-container first"><a class="reference external" href="tutorial.html">SQL式言語チュートリアル</a></span></li>
<li><span class="link-container first"><a class="reference external" href="expression_api.html">SQL Statements and Expressions API(SQL文とAPI式)</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="sqlelement.html">列要素と式</a></span></li>
<li><span class="link-container first"><a class="reference external" href="selectable.html">選択可能オブジェクト、テーブル、FROMオブジェクト</a></span></li>
<li><span class="link-container first"><a class="reference external" href="dml.html">挿入、更新、削除</a></span></li>
<li><span class="link-container first"><a class="reference external" href="functions.html">SQLと汎用関数</a></span></li>
<li class="selected"><span class="link-container first"><strong>カスタムSQLコンストラクトとコンパイル拡張</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#synopsis">シノプシス</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#dialect-specific-compilation-rules">方言固有のコンパイルルール</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#compiling-sub-elements-of-a-custom-expression-construct">カスタム式の構成要素のサブ要素のコンパイル</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#cross-compiling-between-sql-and-ddl-compilers">SQLコンパイラとDDLコンパイラ間のクロスコンパイル</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#enabling-autocommit-on-a-construct">コンストラクトに対する自動コミットの有効化</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#changing-the-default-compilation-of-existing-constructs">既存のコンストラクトのデフォルトコンパイルの変更</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#changing-compilation-of-types">タイプの編集の変更</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#subclassing-guidelines">サブクラス化ガイドライン</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#further-examples">さらなる例</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#utc-timestamp-function">&amp;quot;UTCタイムスタンプ&amp;quot;機能</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#greatest-function">&amp;quot;最高の&amp;quot;機能</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#false-expression">&amp;quot;偽&amp;quot;式</a></span></li>
</ul>
</li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="serializer.html">式シリアライザ拡張</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="schema.html">スキーマ定義言語</a></span></li>
<li><span class="link-container first"><a class="reference external" href="types.html">列とデータ型</a></span></li>
<li><span class="link-container first"><a class="reference external" href="engines_connections.html">エンジンと接続の使用</a></span></li>
<li><span class="link-container first"><a class="reference external" href="api_basics.html">コアAPIの基礎</a></span></li>
</ul>



        </div>

        </div>

    </div>

    

    <div id="docs-body" class="withsidebar" >
        
<div class="section" id="module-sqlalchemy.ext.compiler">
<span id="custom-sql-constructs-and-compilation-extension"></span><span id="sqlalchemy-ext-compiler-toplevel"></span><h1>カスタムSQLコンストラクトとコンパイル拡張<a class="headerlink" href="#module-sqlalchemy.ext.compiler" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>カスタムClauseElementsとコンパイラの作成のためのAPIを提供します。</p>
<div class="section" id="synopsis">
<h2>シノプシス<a class="headerlink" href="#synopsis" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>使用法は、class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.sql.expression.ClauseElement`サブクラスとそのコンパイルを定義する1つ以上の呼び出し可能オブジェクトの作成です。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="k">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">ColumnClause</span>

<span class="k">class</span> <span class="nc">MyColumn</span><span class="p">(</span><span class="n">ColumnClause</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">MyColumn</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_mycolumn</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;[</span><span class="si">%s</span><span class="s2">]&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">name</span></pre></div>
</div>
<p>上記の `` MyColumn``は、class： <cite>〜sqlalchemy.sql.expression.ColumnClause`（名前付きカラムオブジェクトの基本式要素）を拡張しています。 `</cite> compiles``デコレータは `` MyColumn``クラスに自身を登録し、オブジェクトが文字列にコンパイルされたときに呼び出されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">select</span>

<span class="n">s</span> <span class="o">=</span> <span class="n">select</span><span class="p">([</span><span class="n">MyColumn</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">),</span> <span class="n">MyColumn</span><span class="p">(</span><span class="s1">&#39;y&#39;</span><span class="p">)])</span>
<span class="nb">print</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span></pre></div>
</div>
<p>プロデュース:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="p">[</span><span class="n">x</span><span class="p">],</span> <span class="p">[</span><span class="n">y</span><span class="p">]</span></pre></div>
</div>
</div>
<div class="section" id="dialect-specific-compilation-rules">
<h2>方言固有のコンパイルルール<a class="headerlink" href="#dialect-specific-compilation-rules" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>コンパイラは、ダイアレクト固有のものにすることもできます。使用中の方言に対して適切なコンパイラが呼び出されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.schema</span> <span class="k">import</span> <span class="n">DDLElement</span>

<span class="k">class</span> <span class="nc">AlterColumn</span><span class="p">(</span><span class="n">DDLElement</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">column</span><span class="p">,</span> <span class="n">cmd</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">column</span> <span class="o">=</span> <span class="n">column</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cmd</span> <span class="o">=</span> <span class="n">cmd</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">AlterColumn</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">visit_alter_column</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;ALTER COLUMN </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="n">element</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">name</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">AlterColumn</span><span class="p">,</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">visit_alter_column</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;ALTER TABLE </span><span class="si">%s</span><span class="s2"> ALTER COLUMN </span><span class="si">%s</span><span class="s2"> ...&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">table</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                                                   <span class="n">element</span><span class="o">.</span><span class="n">column</span><span class="o">.</span><span class="n">name</span><span class="p">)</span></pre></div>
</div>
<p>2番目の `` visit_alter_table``は、 `` postgresql``の方言が使われたときに呼び出されます。</p>
</div>
<div class="section" id="compiling-sub-elements-of-a-custom-expression-construct">
<h2>カスタム式の構成要素のサブ要素のコンパイル<a class="headerlink" href="#compiling-sub-elements-of-a-custom-expression-construct" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>`` compiler``引数は、使用中の：class： <cite>〜sqlalchemy.engine.interfaces.Compiled`オブジェクトです。このオブジェクトは、 `</cite> compiler.dialect``、 `` compiler.statement``など、実行中のコンパイルに関する情報を調べることができます。class： <cite>〜sqlalchemy.sql.compiler.SQLCompiler`と：class ： `〜sqlalchemy.sql.compiler.DDLCompiler`には、両方とも埋め込み属性のコンパイルに使用できる</cite> <cite>process（）</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>メソッドが含まれています:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">Executable</span><span class="p">,</span> <span class="n">ClauseElement</span>

<span class="k">class</span> <span class="nc">InsertFromSelect</span><span class="p">(</span><span class="n">Executable</span><span class="p">,</span> <span class="n">ClauseElement</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">table</span><span class="p">,</span> <span class="n">select</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table</span> <span class="o">=</span> <span class="n">table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">select</span> <span class="o">=</span> <span class="n">select</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">InsertFromSelect</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">visit_insert_from_select</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;INSERT INTO </span><span class="si">%s</span><span class="s2"> (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">table</span><span class="p">,</span> <span class="n">asfrom</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">select</span><span class="p">)</span>
    <span class="p">)</span>

<span class="n">insert</span> <span class="o">=</span> <span class="n">InsertFromSelect</span><span class="p">(</span><span class="n">t1</span><span class="p">,</span> <span class="n">select</span><span class="p">([</span><span class="n">t1</span><span class="p">])</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">t1</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">x</span><span class="o">&gt;</span><span class="mi">5</span><span class="p">))</span>
<span class="nb">print</span> <span class="n">insert</span></pre></div>
</div>
<p>プロデュース:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="s2">&quot;INSERT INTO mytable (SELECT mytable.x, mytable.y, mytable.z</span>
                      <span class="n">FROM</span> <span class="n">mytable</span> <span class="n">WHERE</span> <span class="n">mytable</span><span class="o">.</span><span class="n">x</span> <span class="o">&gt;</span> <span class="p">:</span><span class="n">x_1</span><span class="p">)</span><span class="s2">&quot;</span></pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">上記の `` InsertFromSelect``構造体は単なる例であり、この実際の機能は：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Insert.from_select`メソッドを使って既に利用可能です。</p>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">上記の `` InsertFromSelect``構造は、おそらく&amp;quot;autocommit &amp;quot;を有効にしたいと考えています。このステップについては、ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>enabling_compiled_autocommit`を参照してください。</p>
</div>
<div class="section" id="cross-compiling-between-sql-and-ddl-compilers">
<h3>SQLコンパイラとDDLコンパイラ間のクロスコンパイル<a class="headerlink" href="#cross-compiling-between-sql-and-ddl-compilers" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SQLとDDLの構造体はそれぞれ異なるベースコンパイラ `` SQLCompiler``と `` DDLCompiler``を使ってコンパイルされます。共通の必要性は、DDL式の中からSQL式のコンパイル規則にアクセスすることです。 `` DDLCompiler``には、次のような理由でアクセサの `` sql_compiler``が含まれています.SQLの式を埋め込むCHECK制約を生成する場所</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@compiles</span><span class="p">(</span><span class="n">MyConstraint</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_my_constraint</span><span class="p">(</span><span class="n">constraint</span><span class="p">,</span> <span class="n">ddlcompiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;CONSTRAINT </span><span class="si">%s</span><span class="s2"> CHECK (</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">constraint</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
        <span class="n">ddlcompiler</span><span class="o">.</span><span class="n">sql_compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span>
            <span class="n">constraint</span><span class="o">.</span><span class="n">expression</span><span class="p">,</span> <span class="n">literal_binds</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="p">)</span></pre></div>
</div>
<p>上記では、：literal_binds``フラグである：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>.SQLCompiler.process`によって呼び出される追加のフラグをプロセスステップに追加します。これは、：class： <a href="#id3"><span class="problematic" id="id4">`</span></a>.BindParameter`オブジェクトまたは文字列や整数を参照するオブジェクトなどの他の&amp;quot;リテラル&amp;quot;オブジェクトを参照するSQL式は、参照されるのではなく**インプレース**でレンダリングされるべきであることを示しますtoを結合パラメータとして; DDLを発行する場合、通常、バインドされたパラメータはサポートされていません。</p>
</div>
</div>
<div class="section" id="enabling-autocommit-on-a-construct">
<span id="enabling-compiled-autocommit"></span><h2>コンストラクトに対する自動コミットの有効化<a class="headerlink" href="#enabling-autocommit-on-a-construct" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>セクション：ref： <cite>autocommit`を思い出してください：class：</cite> .Engine`は、ユーザ定義のトランザクションがない場合にコンストラクトを実行するように要求されたときに、指定されたコンストラクトがDMLまたはDDLを表すかどうかを検出します。 （DDLの場合には、SQLAlchemyの機能とは無関係にDBAPIが常にトランザクションを実行していることを思い出してください）、DBAPIによって生成されたトランザクションがコミットされることを要求します。これを確認するには、実際にはコンストラクターの&amp;quot;autocommit &amp;quot;実行オプションをチェックしてください。 INSERT派生、新しいDDL型、またはおそらくデータを変更するストアド・プロシージャのような構文を構築するときは、文が&amp;quot;コネクションレス&amp;quot;で機能するように&amp;quot;autocommit &amp;quot;オプションを設定する必要があります。 ：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>dbengine_implicit`を参照してください）。</p>
<p>現在、これを行う簡単な方法はclass： <cite>.Executable`をサブクラス化し、&amp;quot; autocommit &amp;quot;フラグを</cite> <cite>_execution_options``ディクショナリに追加することです（これは生成元を提供する&amp;quot;フリーズ&amp;quot;辞書です`</cite> union（） <a href="#id1"><span class="problematic" id="id2">``</span></a>メソッド）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">Executable</span><span class="p">,</span> <span class="n">ClauseElement</span>

<span class="k">class</span> <span class="nc">MyInsertThing</span><span class="p">(</span><span class="n">Executable</span><span class="p">,</span> <span class="n">ClauseElement</span><span class="p">):</span>
    <span class="n">_execution_options</span> <span class="o">=</span> \
        <span class="n">Executable</span><span class="o">.</span><span class="n">_execution_options</span><span class="o">.</span><span class="n">union</span><span class="p">({</span><span class="s1">&#39;autocommit&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">})</span></pre></div>
</div>
<p>より簡単には、構造体が本当にINSERT、UPDATE、またはDELETEに類似している場合は、：class： <cite>.UpdateBase`を使用できます。これは既に：class：</cite> .Executable`、：class： <cite>.ClauseElement</cite> `` autocommit``フラグを含みます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">UpdateBase</span>

<span class="k">class</span> <span class="nc">MyInsertThing</span><span class="p">(</span><span class="n">UpdateBase</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">...</span><span class="p">):</span>
        <span class="o">...</span></pre></div>
</div>
<p>サブクラスであるclass： <a href="#id1"><span class="problematic" id="id2">`</span></a>.DDLElement`のDDL要素はすでに&amp;quot; autocommit &amp;quot;フラグがオンになっています。</p>
</div>
<div class="section" id="changing-the-default-compilation-of-existing-constructs">
<h2>既存のコンストラクトのデフォルトコンパイルの変更<a class="headerlink" href="#changing-the-default-compilation-of-existing-constructs" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>コンパイラの拡張機能は、既存の構造体にも同様に適用されます。ビルドされたSQL構文のコンパイルを無効にすると、&#64; compileデコレータは適切なクラスで呼び出されます（ `` Insert``や `` Select``などのクラスを使用してください） <cite>insert（）</cite> <cite>や</cite> <cite>select（）</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>）を実行します。</p>
<p>新しいコンパイル関数の中で、&amp;quot;オリジナル&amp;quot;コンパイルルーチンを呼び出すには、適切なvisit_XXXメソッドを使用します。これは、compiler.process（）がオーバーライドルーチンを呼び出し、無限ループを引き起こすためです。のような、すべての挿入ステートメントに&amp;quot;プレフィックス&amp;quot;を追加する:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">Insert</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">Insert</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">prefix_inserts</span><span class="p">(</span><span class="n">insert</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">visit_insert</span><span class="p">(</span><span class="n">insert</span><span class="o">.</span><span class="n">prefix_with</span><span class="p">(</span><span class="s2">&quot;some prefix&quot;</span><span class="p">),</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span></pre></div>
</div>
<p>上記のコンパイラは、すべてのINSERT文の前に、コンパイル時に&amp;quot;some prefix &amp;quot;を付けます。</p>
</div>
<div class="section" id="changing-compilation-of-types">
<span id="type-compilation-extension"></span><h2>タイプの編集の変更<a class="headerlink" href="#changing-compilation-of-types" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>`` string`` / `` VARCHAR``にMS-SQL固有の &amp;#39;max&amp;#39;キーワードを実装するところのように、 `` compiler``も型のために働きます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@compiles</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="s1">&#39;mssql&#39;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">VARCHAR</span><span class="p">,</span> <span class="s1">&#39;mssql&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile_varchar</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">element</span><span class="o">.</span><span class="n">length</span> <span class="o">==</span> <span class="s1">&#39;max&#39;</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;VARCHAR(&#39;max&#39;)&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">visit_VARCHAR</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">)</span>

<span class="n">foo</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;data&#39;</span><span class="p">,</span> <span class="n">VARCHAR</span><span class="p">(</span><span class="s1">&#39;max&#39;</span><span class="p">))</span>
<span class="p">)</span></pre></div>
</div>
</div>
<div class="section" id="subclassing-guidelines">
<h2>サブクラス化ガイドライン<a class="headerlink" href="#subclassing-guidelines" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>コンパイラ拡張を使用する大きな部分は、SQLAlchemyの式構造をサブクラス化することです。これを簡単にするために、式とスキーマのパッケージには、共通のタスク用の&amp;quot;塩基&amp;quot;のセットがあります。概要は次のとおりです。</p>
<ul>
<li><p class="first">：class： <cite>〜sqlalchemy.sql.expression.ClauseElement</cite>  - これはルート表現クラスです。どのSQL式もこのベースから派生することができ、特殊なINSERTステートメントのような長い構文の場合はおそらく最良の選択です。</p>
</li>
<li><p class="first">：class： <cite>〜sqlalchemy.sql.expression.ColumnElement</cite>  - すべての「列のような」要素のルート。 SELECTステートメントの &amp;quot;columns&amp;quot;節（およびby by order byとgroup by）は、これから派生することができます。オブジェクトは自動的にPython &amp;quot;comparison &amp;quot;の動作をします。</p>
<p>：class： <cite>〜sqlalchemy.sql.expression.ColumnElement`クラスは、式の戻り値の型である</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>type``メンバを持つことを望みます。これは、コンストラクタのインスタンスレベルで確立することも、クラスレベルで確立することもできます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">timestamp</span><span class="p">(</span><span class="n">ColumnElement</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">TIMESTAMP</span><span class="p">()</span></pre></div>
</div>
</li>
<li><p class="first">：class： <cite>〜sqlalchemy.sql.functions.FunctionElement</cite>  - これは` <cite>ColumnElement``と&amp;quot; from句&amp;quot;のようなオブジェクトのハイブリッドであり、SQL関数またはストアドプロシージャの呼び出しのタイプを表します。ほとんどのデータベースは&amp;quot;SELECT FROM &lt;some function&gt; &amp;quot;</cite> <cite>FunctionElement``は、</cite> <cite>select（）</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>の構造体のFROM句で使用できる機能を追加しています:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql.expression</span> <span class="k">import</span> <span class="n">FunctionElement</span>

<span class="k">class</span> <span class="nc">coalesce</span><span class="p">(</span><span class="n">FunctionElement</span><span class="p">):</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;coalesce&#39;</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">coalesce</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;coalesce(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">coalesce</span><span class="p">,</span> <span class="s1">&#39;oracle&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">compile</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;coalesce only supports two arguments on Oracle&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;nvl(</span><span class="si">%s</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p class="first">：class： <cite>〜sqlalchemy.schema.DDLElement</cite>  -  CREATE TABLE、ALTER TABLEなどのすべてのDDL式のルートです。` <cite>DDLElement``サブクラスのコンパイルは</cite> <cite>DDLCompiler``の代わりに</cite> <cite>DDLCompiler``によって発行されます。 SQLCompiler``です。 `</cite> DDLElement``は、 `` Table``と `` MetaData``イベントが `` execute_at（） <a href="#id1"><span class="problematic" id="id2">``</span></a>メソッドを介してフックし、CREATE TABLEとDROP TABLEのシーケンス中に呼び出されるようにしています。</p>
</li>
<li><p class="first">：class： <cite>〜sqlalchemy.sql.expression.Executable</cite>  - これは、` <cite>execute（）</cite> <cite>メソッドに直接渡すことができるスタンドアロンのSQLステートメントを表す任意の式クラスで使用されるミックスインですすでに `</cite> DDLElement``と `` FunctionElement``の中に暗黙のうちに入っています。</p>
</li>
</ul>
</div>
<div class="section" id="further-examples">
<h2>さらなる例<a class="headerlink" href="#further-examples" title="このヘッドラインへのパーマリンク">¶</a></h2>
<div class="section" id="utc-timestamp-function">
<h3>&amp;quot;UTCタイムスタンプ&amp;quot;機能<a class="headerlink" href="#utc-timestamp-function" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>&amp;quot;CURRENT_TIMESTAMP &amp;quot;のように動作する関数は、時間がUTC時間になるように適切な変換を適用します。タイムスタンプは、タイムゾーンなしでリレーショナルデータベースにUTCとして保存するのが最適です。タイムゾーンが文字エンコードのようなものであるため、データベースでは夏時間が終了した時刻に時間が逆転しているとは考えられません。アプリケーションのエンドポイントでのみ適用するのが最適です（つまり、ユーザー入力時にUTCに変換、表示時に希望のタイムゾーンを再適用する）。</p>
<p>PostgreSQLとMicrosoft SQL Serverの場合:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="k">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="k">import</span> <span class="n">DateTime</span>

<span class="k">class</span> <span class="nc">utcnow</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">FunctionElement</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">DateTime</span><span class="p">()</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">utcnow</span><span class="p">,</span> <span class="s1">&#39;postgresql&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">pg_utcnow</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;TIMEZONE(&#39;utc&#39;, CURRENT_TIMESTAMP)&quot;</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">utcnow</span><span class="p">,</span> <span class="s1">&#39;mssql&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">ms_utcnow</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;GETUTCDATE()&quot;</span></pre></div>
</div>
<p>使用例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="p">(</span>
            <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">MetaData</span>
        <span class="p">)</span>
<span class="n">metadata</span> <span class="o">=</span> <span class="n">MetaData</span><span class="p">()</span>
<span class="n">event</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s2">&quot;event&quot;</span><span class="p">,</span> <span class="n">metadata</span><span class="p">,</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">Column</span><span class="p">(</span><span class="s2">&quot;timestamp&quot;</span><span class="p">,</span> <span class="n">DateTime</span><span class="p">,</span> <span class="n">server_default</span><span class="o">=</span><span class="n">utcnow</span><span class="p">())</span>
<span class="p">)</span></pre></div>
</div>
</div>
<div class="section" id="greatest-function">
<h3>&amp;quot;最高の&amp;quot;機能<a class="headerlink" href="#greatest-function" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>&amp;quot;GREATEST &amp;quot;関数は任意の数の引数を与えられ、最も高い値のものを返します。これはPythonの `` max``関数に相当します。 SQL標準バージョンとCASEベースバージョンの2つの引数のみを扱う:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="k">import</span> <span class="n">compiles</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.types</span> <span class="k">import</span> <span class="n">Numeric</span>

<span class="k">class</span> <span class="nc">greatest</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">FunctionElement</span><span class="p">):</span>
    <span class="nb">type</span> <span class="o">=</span> <span class="n">Numeric</span><span class="p">()</span>
    <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;greatest&#39;</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">greatest</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">default_greatest</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">compiler</span><span class="o">.</span><span class="n">visit_function</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">greatest</span><span class="p">,</span> <span class="s1">&#39;sqlite&#39;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">greatest</span><span class="p">,</span> <span class="s1">&#39;mssql&#39;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">greatest</span><span class="p">,</span> <span class="s1">&#39;oracle&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">case_greatest</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="n">arg1</span><span class="p">,</span> <span class="n">arg2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">element</span><span class="o">.</span><span class="n">clauses</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;CASE WHEN </span><span class="si">%s</span><span class="s2"> &gt; </span><span class="si">%s</span><span class="s2"> THEN </span><span class="si">%s</span><span class="s2"> ELSE </span><span class="si">%s</span><span class="s2"> END&quot;</span> <span class="o">%</span> <span class="p">(</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arg1</span><span class="p">),</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arg2</span><span class="p">),</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arg1</span><span class="p">),</span>
        <span class="n">compiler</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">arg2</span><span class="p">),</span>
    <span class="p">)</span></pre></div>
</div>
<p>使用例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Account</span><span class="p">)</span><span class="o">.</span>\
        <span class="nb">filter</span><span class="p">(</span>
            <span class="n">greatest</span><span class="p">(</span>
                <span class="n">Account</span><span class="o">.</span><span class="n">checking_balance</span><span class="p">,</span>
                <span class="n">Account</span><span class="o">.</span><span class="n">savings_balance</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">10000</span>
        <span class="p">)</span></pre></div>
</div>
</div>
<div class="section" id="false-expression">
<h3>&amp;quot;偽&amp;quot;式<a class="headerlink" href="#false-expression" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>&amp;quot;false &amp;quot;定数を持たないプラットフォームで&amp;quot;0 &amp;quot;と表現する&amp;quot;false &amp;quot;定数式をレンダリングする:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">expression</span>
<span class="kn">from</span> <span class="nn">sqlalchemy.ext.compiler</span> <span class="k">import</span> <span class="n">compiles</span>

<span class="k">class</span> <span class="nc">sql_false</span><span class="p">(</span><span class="n">expression</span><span class="o">.</span><span class="n">ColumnElement</span><span class="p">):</span>
    <span class="k">pass</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">sql_false</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">default_false</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;false&quot;</span>

<span class="nd">@compiles</span><span class="p">(</span><span class="n">sql_false</span><span class="p">,</span> <span class="s1">&#39;mssql&#39;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">sql_false</span><span class="p">,</span> <span class="s1">&#39;mysql&#39;</span><span class="p">)</span>
<span class="nd">@compiles</span><span class="p">(</span><span class="n">sql_false</span><span class="p">,</span> <span class="s1">&#39;oracle&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">int_false</span><span class="p">(</span><span class="n">element</span><span class="p">,</span> <span class="n">compiler</span><span class="p">,</span> <span class="o">**</span><span class="n">kw</span><span class="p">):</span>
    <span class="k">return</span> <span class="s2">&quot;0&quot;</span></pre></div>
</div>
<p>使用例:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">select</span><span class="p">,</span> <span class="n">union_all</span>

<span class="n">exp</span> <span class="o">=</span> <span class="n">union_all</span><span class="p">(</span>
    <span class="n">select</span><span class="p">([</span><span class="n">users</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">sql_false</span><span class="p">()</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s2">&quot;enrolled&quot;</span><span class="p">)]),</span>
    <span class="n">select</span><span class="p">([</span><span class="n">customers</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">customers</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">enrolled</span><span class="p">])</span>
<span class="p">)</span></pre></div>
</div>
<dl class="function">
<dt id="sqlalchemy.ext.compiler.compiles">
<code class="descclassname">sqlalchemy.ext.compiler.</code><code class="descname">compiles</code><span class="sig-paren">(</span><em>class_</em>, <em>*specs</em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.ext.compiler.compiles" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>与えられた：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.ClauseElement`型のコンパイラとして関数を登録します。</p>
</dd></dl>

<dl class="function">
<dt id="sqlalchemy.ext.compiler.deregister">
<code class="descclassname">sqlalchemy.ext.compiler.</code><code class="descname">deregister</code><span class="sig-paren">(</span><em>class_</em><span class="sig-paren">)</span><a class="headerlink" href="#sqlalchemy.ext.compiler.deregister" title="この定義へのパーマリンク">¶</a></dt>
<dd><p>指定された：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.ClauseElement`型に関連するすべてのカスタムコンパイラを削除します。</p>
</dd></dl>

</div>
</div>
</div>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="functions.html" title="previous chapter">SQLと汎用関数</a>
        Next:
        <a href="serializer.html" title="next chapter">式シリアライザ拡張</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2018, the SQLAlchemy authors and contributors.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.8.1.
    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.3.0b1',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


