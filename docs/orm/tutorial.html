<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">



<html xmlns="http://www.w3.org/1999/xhtml">
    <head>
        <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
        
        <title>
            
    
    オブジェクトリレーショナルチュートリアル
 &mdash;
    SQLAlchemy 1.3 Documentation

        </title>

        
            <!-- begin iterate through site-imported + sphinx environment css_files -->
                <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
                <link rel="stylesheet" href="../_static/docs.css" type="text/css" />
                <link rel="stylesheet" href="../_static/changelog.css" type="text/css" />
                <link rel="stylesheet" href="../_static/sphinx_paramlinks.css" type="text/css" />
            <!-- end iterate through site-imported + sphinx environment css_files -->
        

        

    

    <!-- begin layout.mako headers -->

    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
        <link rel="copyright" title="Copyright" href="../copyright.html" />
    <link rel="top" title="SQLAlchemy 1.3 Documentation" href="../index.html" />
        <link rel="up" title="SQLAlchemy ORM" href="index.html" />
        <link rel="next" title="マッパー設定" href="mapper_config.html" />
        <link rel="prev" title="SQLAlchemy ORM" href="index.html" />
    <!-- end layout.mako headers -->


    </head>
    <body>
        
















<div id="docs-container">





<div id="docs-top-navigation-container" class="body-background">
<div id="docs-header">
    <div id="docs-version-header">
        Release: <span class="version-num">1.3.0b1</span>


        | Release Date: unreleased

    </div>

    <h1>SQLAlchemy 1.3 Documentation</h1>

</div>
</div>

<div id="docs-body-container">

    <div id="fixed-sidebar" class="withsidebar">


        <div id="docs-sidebar-popout">
            <h3><a href="../index.html">SQLAlchemy 1.3 Documentation</a></h3>
            <p id="sidebar-topnav">
                <a href="../contents.html">Contents</a> |
                <a href="../genindex.html">Index</a>
            </p>

            <div id="sidebar-search">
                <form class="search" action="../search.html" method="get">
                  <label>
                  Search terms:
                  <input type="text" placeholder="search..." name="q" size="12" />
                  </label>
                  <input type="hidden" name="check_keywords" value="yes" />
                  <input type="hidden" name="area" value="default" />
                </form>
            </div>

        </div>

        <div id="docs-sidebar">

        <div id="sidebar-banner">
            
        </div>

        <div id="docs-sidebar-inner">

        
        <h3>
            <a href="index.html" title="SQLAlchemy ORM">SQLAlchemy ORM</a>
        </h3>

        <ul>
<li class="selected"><span class="link-container first"><strong>オブジェクトリレーショナルチュートリアル</strong><a class="paramlink headerlink reference internal" href="#">¶</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#version-check">バージョンチェック</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#connecting">接続する</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#declare-a-mapping">マッピングを宣言する</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#create-a-schema">スキーマの作成</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#create-an-instance-of-the-mapped-class">マップされたクラスのインスタンスを作成する</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#creating-a-session">セッションの作成</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#adding-and-updating-objects">オブジェクトの追加と更新</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#rolling-back">ロールバック</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#querying">クエリ</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#common-filter-operators">一般的なフィルタ演算子</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#returning-lists-and-scalars">リストとスカラーを返す</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#using-textual-sql">テキストSQLの使用</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#counting">カウント</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#building-a-relationship">関係を構築する</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#working-with-related-objects">関連オブジェクトの操作</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#querying-with-joins">ジョインを使用したクエリ</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#using-aliases">エイリアスの使用</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#using-subqueries">サブクエリの使用</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#selecting-entities-from-subqueries">サブクエリからエンティティを選択する</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#using-exists">EXISTSの使用</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#common-relationship-operators">共通関係演算子</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#eager-loading">Eager Loading</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#subquery-load">サブクエリのロード</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#joined-load">結合荷重</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#explicit-join-eagerload">明示的な結合+ Eagerload</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#deleting">削除</a></span><ul>
<li><span class="link-container first"><a class="reference external" href="#configuring-delete-delete-orphan-cascade">delete / delete-orphanカスケードの設定</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="#building-a-many-to-many-relationship">多対多の関係を構築する</a></span></li>
<li><span class="link-container first"><a class="reference external" href="#further-reference">さらなる参照</a></span></li>
</ul>
</li>
<li><span class="link-container first"><a class="reference external" href="mapper_config.html">マッパー設定</a></span></li>
<li><span class="link-container first"><a class="reference external" href="relationships.html">関係の設定</a></span></li>
<li><span class="link-container first"><a class="reference external" href="loading_objects.html">オブジェクトの読み込み</a></span></li>
<li><span class="link-container first"><a class="reference external" href="session.html">セッションの使用</a></span></li>
<li><span class="link-container first"><a class="reference external" href="extending.html">イベントと内部</a></span></li>
<li><span class="link-container first"><a class="reference external" href="extensions/index.html">ORM拡張</a></span></li>
<li><span class="link-container first"><a class="reference external" href="examples.html">ORMの例</a></span></li>
</ul>



        </div>

        </div>

    </div>

    

    <div id="docs-body" class="withsidebar" >
        
<div class="section" id="object-relational-tutorial">
<span id="ormtutorial-toplevel"></span><h1>オブジェクトリレーショナルチュートリアル<a class="headerlink" href="#object-relational-tutorial" title="このヘッドラインへのパーマリンク">¶</a></h1>
<p>SQLAlchemyオブジェクト・リレーショナル・マッパーは、ユーザー定義のPythonクラスをデータベース表、および対応する表に行を持つそれらのクラス（オブジェクト）のインスタンスに関連付ける方法を提供します。これには、用語： <a href="#id1"><span class="problematic" id="id2">`</span></a>作業単位（unit of work） &amp;#39;と呼ばれるオブジェクトとその関連行の間の状態のすべての変化を透過的に同期させるシステムと、ユーザー定義のクラスとそれらの定義された関係の観点からデータベースクエリを表現するシステムお互い。</p>
<p>ORMは、ORMが構築されるSQLAlchemy Expression Languageとは対照的です。 ：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>sqlexpression_toplevel`で紹介されているSQL式言語は、リレーショナル・データベースのプリミティブ構造を意見なしで直接表現するシステムを提示しますが、ORMは高レベルで抽象化された使用パターンを提示します。表現言語の使い方。</p>
<p>ORMと表現言語の使用パターンには重複がありますが、類似点は最初に現れるよりも表面的です。ユーザ定義の用語：ドメインモデルの観点から、データの構造と内容にアプローチします。この用語は、透過的に永続化され、その基礎となるストレージモデルからリフレッシュされます。もう1つは、データベースによって個別に消費されるメッセージに明示的に構成されたリテラルスキーマとSQL式表現の観点からアプローチする方法です。</p>
<p>オブジェクトリレーショナルマッパーを排他的に使用して、正常なアプリケーションを構築することができます。高度な状況では、ORMを使用して構築されたアプリケーションは、特定のデータベース対話が必要な特定の領域で直接Expression Languageを使用することがあります。</p>
<p>次のチュートリアルはdoctest形式です。つまり、 `` &amp;gt;&amp;gt;&amp;gt; <a href="#id1"><span class="problematic" id="id2">``</span></a>の行はPythonコマンドプロンプトで入力できるものを表し、次のテキストは期待される戻り値を表します。</p>
<div class="section" id="version-check">
<h2>バージョンチェック<a class="headerlink" href="#version-check" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>私たちが少なくともSQLAlchemyのバージョン1.3 ** <a href="#id1"><span class="problematic" id="id2">**</span></a>にいることを確認するためのクイックチェック:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sqlalchemy</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">sqlalchemy</span><span class="o">.</span><span class="n">__version__</span> 
<span class="go">1.3.0</span></pre></div>
</div>
</div>
<div class="section" id="connecting">
<h2>接続する<a class="headerlink" href="#connecting" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>このチュートリアルでは、メモリ内のSQLiteデータベースを使用します。接続するには：func： <cite>〜sqlalchemy.create_engine</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">create_engine</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">engine</span> <span class="o">=</span> <span class="n">create_engine</span><span class="p">(</span><span class="s1">&#39;sqlite:///:memory:&#39;</span><span class="p">,</span> <span class="n">echo</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>`` echo``フラグは、SQLAlchemyのロギングを設定するためのショートカットです。これは、Pythonの標準の `` logging``モジュールによって実現されます。これを有効にすると、生成されたすべての生成SQLが表示されます。このチュートリアルで作業しており、生成される出力が少なくてすむようなら、 `` False``に設定してください。このチュートリアルでは、SQLをポップアップウィンドウの後ろに書式設定して、私たちのやり方では得られないようにします。 &amp;quot;SQL &amp;quot;リンクをクリックして、何が生成されているかを確認してください。</p>
<p>：func： <cite>.create_engine`の戻り値は：class：</cite> .Engine`のインスタンスであり、データベースのコアインタフェースを表し、：term： <cite>dialect`によって適合され、データベースの詳細を処理します。 ：term： `DBAPI`が使用中です。この場合、SQLiteダイアレクトはPythonの組み込み `</cite> sqlite3``モジュールへの命令を解釈します。</p>
<div class="sidebar">
<p class="first sidebar-title">Lazy Connecting</p>
<p class="last">：class： <cite>.Engine`は：func：</cite> .create_engine`によって最初に返されたときに、まだデータベースに接続しようとしていません。これは、初めてデータベースに対してタスクを実行するように要求されたときにのみ発生します。</p>
</div>
<p>初めて：meth： <cite>.Engine.execute`や：meth：</cite> .Engine.connect`のようなメソッドが呼び出されると、class： <cite>.Engine`はデータベースへのreal：term：</cite> DBAPI`接続を確立します。これを使用してSQLを発行します。 ORMを使用する場合、通常は一度作成された：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Engine`を使用しません。代わりに、これはORMによって舞台裏で使用されています。</p>
<div class="admonition seealso">
<p class="first admonition-title">参考</p>
<p class="last">：ref： <cite>database_urls</cite>  - いくつかの種類のデータベースに接続する：func：` .create_engine`の例を含んでいます。</p>
</div>
</div>
<div class="section" id="declare-a-mapping">
<h2>マッピングを宣言する<a class="headerlink" href="#declare-a-mapping" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ORMを使用する場合、構成プロセスは、処理対象のデータベーステーブルを記述し、次にそれらのテーブルにマップされる独自のクラスを定義することから始まります。現代のSQLAlchemyでは、これらの2つのタスクは通常：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>declarative_toplevel`というシステムを使用して一緒に実行され、マップされる実際のデータベーステーブルを記述するディレクティブを含むクラスを作成することができます。</p>
<p>宣言システムを使用してマップされたクラスは、そのベースに対するクラスとテーブルのカタログを保持する基本クラスの観点から定義されます。これは**宣言的な基本クラス**と呼ばれます。私たちのアプリケーションは通常、一般にインポートされたモジュールにこのベースのインスタンスを1つだけ持ちます。 ：func： <a href="#id1"><span class="problematic" id="id2">`</span></a>.declarative_base`関数を使って基本クラスを作成します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.ext.declarative</span> <span class="k">import</span> <span class="n">declarative_base</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span></pre></div>
</div>
<p>今では&amp;quot;base &amp;quot;を持っているので、マップされたクラスをいくつでも定義することができます。私たちはアプリケーションを使用してエンドユーザーのためのレコードを格納する `` users``という単一のテーブルから始めます。 `` User``という新しいクラスが、このテーブルをマップするクラスになります。クラス内では、マッピングするテーブル、主にテーブル名、カラムの名前とデータ型に関する詳細を定義します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Column</span><span class="p">,</span> <span class="n">Integer</span><span class="p">,</span> <span class="n">String</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">fullname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">password</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>       <span class="k">return</span> <span class="s2">&quot;&lt;User(name=&#39;</span><span class="si">%s</span><span class="s2">&#39;, fullname=&#39;</span><span class="si">%s</span><span class="s2">&#39;, password=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>                            <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span></pre></div>
</div>
<div class="sidebar">
<p class="first sidebar-title">Tip</p>
<p class="last">`` User``クラスは `` __repr __（） <a href="#id1"><span class="problematic" id="id2">``</span></a>メソッドを定義しますが、** ** ** <a href="#id3"><span class="problematic" id="id4">**</span></a>;私たちはこのチュートリアルでのみ実装していますので、ここでの例はきれいにフォーマットされた `` User``オブジェクトを示しています。</p>
</div>
<p>Declarativeを最低限必要とするクラスは、 `` __tablename__``属性と、主キーの一部であるclass： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Column`の少なくとも1つの属性を必要とします。 SQLAlchemyは、名前、データ型、または制約に組み込みの規則がないなど、クラスが参照するテーブルについては何も仮定しません。しかし、これは定型句が必要であるということを意味するものではありません。代わりに、ヘルパー関数とmixinクラスを使用して独自の自動慣習を作成することをお勧めします。詳細については、ref： <a href="#id3"><span class="problematic" id="id4">`</span></a>declarative_mixins`を参照してください。</p>
<p>私たちのクラスが構築されると、Declarativeは：class： <cite>.Column`オブジェクトをすべて、term：</cite> descriptors`と呼ばれる特殊なPythonアクセサで置き換えます。これは、term： <a href="#id1"><span class="problematic" id="id2">`</span></a>instrumentation`と呼ばれるプロセスです。マッピングされた&amp;quot;instrumented &amp;quot;クラスは、SQLコンテキストでテーブルを参照したり、データベースからカラムの値を保持したり読み込んだりする手段を提供します。</p>
<p>マッピング処理が私たちのクラスに対して行っていること以外は、クラスは普通は普通のPythonクラスのままであり、アプリケーションに必要な任意の数の通常の属性とメソッドを定義することができます。</p>
<table class="docutils footnote" frame="void" id="id2" rules="none">
<colgroup><col class="label" /><col /></colgroup>
<tbody valign="top">
<tr><td class="label"><a class="fn-backref" href="#id1">[1]</a></td><td>主キーが必要な理由については、ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>faq_mapper_primary_key`を参照してください。</td></tr>
</tbody>
</table>
</div>
<div class="section" id="create-a-schema">
<h2>スキーマの作成<a class="headerlink" href="#create-a-schema" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>Declarativeシステムで構築された `` User``クラスでは、term： <cite>table metadata`と呼ばれるテーブルに関する情報を定義しています。特定のテーブルに対してこの情報を表すためにSQLAlchemyが使用するオブジェクトは：class： `.Table`オブジェクトと呼ばれ、Declarativeが私たちのために作成しました。このオブジェクトは `</cite> __table__``属性を調べることで見ることができます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">__table__</span> 
<span class="go">Table(&#39;users&#39;, MetaData(bind=None),</span>
<span class="go">            Column(&#39;id&#39;, Integer(), table=&lt;users&gt;, primary_key=True, nullable=False),</span>
<span class="go">            Column(&#39;name&#39;, String(), table=&lt;users&gt;),</span>
<span class="go">            Column(&#39;fullname&#39;, String(), table=&lt;users&gt;),</span>
<span class="go">            Column(&#39;password&#39;, String(), table=&lt;users&gt;), schema=None)</span></pre></div>
</div>
<div class="sidebar">
<p class="first sidebar-title">Classical Mappings</p>
<p class="last">宣言システムは、SQLAlchemyのORMを使用するために必須ではありませんが、必須です。 Declarativeの外では、プレーンなPythonクラスは：：func： <cite>.mapper`関数を直接使って：class：</cite> .Table`にマップすることができます。これほど一般的でない使い方については、ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>classical_mapping`を参照してください。</p>
</div>
<p>私たちがクラスを宣言したとき、Declarativeはクラス宣言が完了したら追加のアクティビティを実行するためにPythonメタクラスを使用しました。この段階で、私たちの仕様に従って：class： <cite>.Table`オブジェクトを作成し、：class：</cite> .Mapper`オブジェクトを作成することによってクラスに関連付けました。このオブジェクトは、通常は直接処理する必要のない背後にあるオブジェクトです（ただし、必要なときにマッピングに関する豊富な情報を提供できます）。</p>
<p>：class： <cite>.Table`オブジェクトは、class：</cite> .MetaData`と呼ばれる大きなコレクションのメンバーです。 Declarativeを使用する場合、このオブジェクトは、宣言的な基本クラスの `` .metadata``属性を使用して使用できます。</p>
<p>：class： <cite>.MetaData`は：term：</cite> registry`です。これには、限られたスキーマ生成コマンドセットをデータベースに出す機能が含まれています。私たちのSQLiteデータベースは実際には `` users``テーブルを持っていないので、class： <cite>.MetaData`を使って、まだ存在しないすべてのテーブルに対してCREATE TABLE文をデータベースに発行することができます。以下では、：meth： `.MetaData.create_all`メソッドを呼び出して、：class：</cite> .Engine`をデータベース接続のソースとして渡します。 `` users``テーブルが存在するかどうかをチェックするために特別なコマンドが最初に生成され、それに続いて実際の `` CREATE TABLE``ステートメントが表示されます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<span class="n">SELECT</span> <span class="o">...</span>
<span class="n">PRAGMA</span> <span class="n">table_info</span><span class="p">(</span><span class="s2">&quot;users&quot;</span><span class="p">)</span>
<span class="p">()</span>
<span class="n">CREATE</span> <span class="n">TABLE</span> <span class="n">users</span> <span class="p">(</span>
    <span class="nb">id</span> <span class="n">INTEGER</span> <span class="n">NOT</span> <span class="n">NULL</span><span class="p">,</span> <span class="n">name</span> <span class="n">VARCHAR</span><span class="p">,</span>
    <span class="n">fullname</span> <span class="n">VARCHAR</span><span class="p">,</span>
    <span class="n">password</span> <span class="n">VARCHAR</span><span class="p">,</span>
    <span class="n">PRIMARY</span> <span class="n">KEY</span> <span class="p">(</span><span class="nb">id</span><span class="p">)</span>
<span class="p">)</span>
<span class="p">()</span>
<span class="n">COMMIT</span></pre></div>
</div>
<div class="topic">
<p class="topic-title first">Minimal Table Descriptions vs. Full Descriptions</p>
<p>CREATE TABLEの構文に精通しているユーザーは、VARCHAR列が長さなしで生成されたことに気付くことがあります。 SQLiteとPostgreSQLでは、これは有効なデータ型ですが、他のものでは許可されていません。したがって、これらのデータベースの1つでこのチュートリアルを実行し、SQLAlchemyを使用してCREATE TABLEを発行する場合は、以下のようにclass： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.types.String`型に&amp;quot; length &amp;quot;を指定することができます。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span></pre></div>
</div>
<p>長さフィールドは：class： <cite>〜sqlalchemy.types.String`と同様の精度/スケールフィールドで利用できます：class：</cite>〜sqlalchemy.types.Integer`、：class： <cite>〜sqlalchemy.types.Numeric</cite>、テーブルの作成時以外はSQLAlchemyによって参照されません。</p>
<p>さらに、FirebirdとOracleは新しい主キー識別子を生成するためにシーケンスを必要とし、SQLAlchemyは指示されずにこれらを生成したり仮定したりしません。そのためには、：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.schema.Sequence`コンストラクトを使用します：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Sequence</span>
<span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">(</span><span class="s1">&#39;user_id_seq&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span></pre></div>
</div>
<p>したがって、完全で完全な：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.schema.Table`は、宣言的マッピングによって生成されます:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">Sequence</span><span class="p">(</span><span class="s1">&#39;user_id_seq&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">fullname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">))</span>
    <span class="n">password</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">12</span><span class="p">))</span>

    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;&lt;User(name=&#39;</span><span class="si">%s</span><span class="s2">&#39;, fullname=&#39;</span><span class="si">%s</span><span class="s2">&#39;, password=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span></pre></div>
</div>
<p>このより冗長なテーブル定義を個別に含めて、主にPythonでの使用のみに対応する最小構成と、より厳しい要件を持つ特定のバックエンドでCREATE TABLEステートメントを発行するために使用される構成との違いを強調します。</p>
</div>
</div>
<div class="section" id="create-an-instance-of-the-mapped-class">
<h2>マップされたクラスのインスタンスを作成する<a class="headerlink" href="#create-an-instance-of-the-mapped-class" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>マッピングが完了したら、 `` User``オブジェクトを作成して検査しましょう:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ed_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;edspassword&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ed_user</span><span class="o">.</span><span class="n">name</span>
<span class="go">&#39;ed&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">ed_user</span><span class="o">.</span><span class="n">password</span>
<span class="go">&#39;edspassword&#39;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">str</span><span class="p">(</span><span class="n">ed_user</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<span class="go">&#39;None&#39;</span></pre></div>
</div>
<div class="sidebar">
<p class="first sidebar-title">the <code class="docutils literal notranslate"><span class="pre">__init__()</span></code> method</p>
<p class="last">Declarativeシステムで定義された `` User``クラスには、マップしたカラムに一致するキーワード名を自動的に受け入れるコンストラクタ（例えば `` __init __（） <a href="#id1"><span class="problematic" id="id2">``</span></a>メソッド）が用意されています。私たちがクラスで好む明示的な `` __init __（） <a href="#id3"><span class="problematic" id="id4">``</span></a>メソッドを自由に定義することができます。これはDeclarativeによって提供されるデフォルトメソッドをオーバーライドします。</p>
</div>
<p>コンストラクタでそれを指定していないにもかかわらず、 `` id``属性は、アクセスしたときに `` None``という値を生成します（Pythonの通常の未定義の場合の `` AttributeError``の振る舞い属性）。 SQLAlchemyの：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>instrumentation`は、最初にアクセスされたときに、カラムマップされた属性に対してこのデフォルト値を生成します。実際に値を割り当てた属性の場合、計装システムは、最終的なINSERTステートメント内で使用するために割り当てを追跡し、データベースに出力します。</p>
</div>
<div class="section" id="creating-a-session">
<h2>セッションの作成<a class="headerlink" href="#creating-a-session" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>これで、データベースとの会話を開始する準備が整いました。データベースに対するORMの &amp;quot;ハンドル&amp;quot;は：class： <cite>〜sqlalchemy.orm.session.Session`です。 ：func： `〜sqlalchemy.create_engine`ステートメントと同じレベルでアプリケーションを最初にセットアップするとき、新しいクラスのファクトリとして機能する：class：</cite>〜sqlalchemy.orm.session.Session`クラスを定義します：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.session.Session`オブジェクト:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="k">import</span> <span class="n">sessionmaker</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span></pre></div>
</div>
<p>モジュールレベルのオブジェクトを定義するときに、アプリケーションがまだ：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.engine.Engine`を持っていない場合は、次のように設定してください:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Session</span> <span class="o">=</span> <span class="n">sessionmaker</span><span class="p">()</span></pre></div>
</div>
<p>後で：func： <cite>〜sqlalchemy.create_engine`でエンジンを作成するときは、：meth：</cite>〜.sessionmaker.configure` ::を使用して：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.session.Session`に接続してください。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Session</span><span class="o">.</span><span class="n">configure</span><span class="p">(</span><span class="n">bind</span><span class="o">=</span><span class="n">engine</span><span class="p">)</span>  <span class="c1"># once engine is available</span></pre></div>
</div>
<div class="sidebar">
<p class="first sidebar-title">Session Lifecycle Patterns</p>
<p class="last">どのようなアプリケーションが構築されているかは、class： <cite>Session。 class： `.Session`は、あなたのオブジェクトのためのワークスペースです。特定のデータベース接続のローカルです。アプリケーションスレッドをディナーパーティーのゲストとして考えるなら、：class：</cite> .Session`ゲストの食器であり、それが保持するオブジェクトは食べ物（そしてデータベース...キッチンですか？）です！このトピックについては、ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>session_faq_whentocreate`を参照してください。</p>
</div>
<p>このカスタムメイドの：class： <cite>〜sqlalchemy.orm.session.Session`クラスは、データベースにバインドされたnew：class：</cite>〜sqlalchemy.orm.session.Session`オブジェクトを作成します。 class： <cite>〜.sessionmaker`を呼び出しても、他のトランザクション特性を定義することができます。これらについては後の章で説明します。次に、データベースと対話する必要があるときはいつでも：class： `〜sqlalchemy.orm.session.Session</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span> <span class="o">=</span> <span class="n">Session</span><span class="p">()</span></pre></div>
</div>
<p>上記の：class： <cite>〜sqlalchemy.orm.session.Session`は、SQLite対応の：class：</cite> .Engine`に関連付けられていますが、まだ接続を開いていません。最初に使用されるときは、：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Engine`によって維持されている接続プールから接続を取得し、すべての変更をコミットするか、セッションオブジェクトを閉じるまで保持します。</p>
</div>
<div class="section" id="adding-and-updating-objects">
<h2>オブジェクトの追加と更新<a class="headerlink" href="#adding-and-updating-objects" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>`` User``オブジェクトを永続化するには、：meth： <cite>〜.Session.add</cite>：class：<cite>〜sqlalchemy.orm.session.Session</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ed_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;edspassword&#39;</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ed_user</span><span class="p">)</span></pre></div>
</div>
<p>現時点では、インスタンスは**保留中**です。 SQLはまだ発行されておらず、オブジェクトはまだデータベース内の行によって表されていません。 ：class： <cite>〜sqlalchemy.orm.session.Session`は、** flush **と呼ばれるプロセスを使用して、必要に応じて直ちに</cite> <cite>Ed Jones``を持続させるためにSQLを発行します。 `</cite> Ed Jones``をデータベースに照会すると、保留中の情報はすべてフラッシュされ、その直後に照会が発行されます。</p>
<p>たとえば、以下のように `` User``のインスタンスをロードする新しい：class： <cite>〜sqlalchemy.orm.query.Query`オブジェクトを作成します。 `</cite> ed``の `` name``属性でフィルタリングし、行の完全なリストの最初の結果のみを表示することを示します。私たちが追加したものと同等の `` User``インスタンスが返されます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">our_user</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">first</span><span class="p">()</span> 
<div class='popup_sql'>BEGIN (implicit)
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
(&#39;ed&#39;, &#39;Ed Jones&#39;, &#39;edspassword&#39;)
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name = ?
 LIMIT ? OFFSET ?
(&#39;ed&#39;, 1, 0)
</div><span class="o">&gt;&gt;&gt;</span> <span class="n">our_user</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;edspassword&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<p>実際には：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.session.Session`は、返された行がオブジェクトの内部マップ内ですでに表現されているものと同じ**行であることを認識しました。私たちがちょうど追加したもの:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">ed_user</span> <span class="ow">is</span> <span class="n">our_user</span>
<span class="go">True</span></pre></div>
</div>
<p>ここで作業中のORMの概念は：term： <cite>identity map`と呼ばれ、a：class：</cite>〜sqlalchemy.orm.session.Session`内の特定の行に対するすべての操作が同じデータセットを操作することを保証します。特定の主キーを持つオブジェクトが：class： <cite>〜sqlalchemy.orm.session.Session`に存在すると、それに関するすべてのSQLクエリ：class：</cite>〜sqlalchemy.orm.session.Session`は常に同じPythonを返しますその特定の主キーのオブジェクト。同じプライマリ・キーを持つ2番目のすでに永続化されたオブジェクトをセッション内に配置しようとすると、エラーが発生します。</p>
<p>func： <cite>〜sqlalchemy.orm.session.Session.add_all</cite>：を使用して、さらに多くの` <a href="#id1"><span class="problematic" id="id2">`</span></a>User``オブジェクトを追加できます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">add_all</span><span class="p">([</span>
<span class="o">...</span>     <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">),</span>
<span class="o">...</span>     <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mary&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Mary Contrary&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;xxg527&#39;</span><span class="p">),</span>
<span class="o">...</span>     <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Fred Flinstone&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;blah&#39;</span><span class="p">)])</span></pre></div>
</div>
<p>また、私たちはEdのパスワードがあまり安全ではないと判断しましたので、変更してください：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">ed_user</span><span class="o">.</span><span class="n">password</span> <span class="o">=</span> <span class="s1">&#39;f8s7ccs&#39;</span></pre></div>
</div>
<p>：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.session.Session`が注目されています。例えば、「エド・ジョーンズ（Ed Jones）」が変更されていることが分かっています。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">dirty</span>
<span class="n">IdentitySet</span><span class="p">([</span><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">])</span></pre></div>
</div>
<p>3つの新しい `` User``オブジェクトが保留中であることを示します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">new</span>  
<span class="n">IdentitySet</span><span class="p">([</span><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mary&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Mary Contrary&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;xxg527&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Fred Flinstone&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;blah&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">])</span></pre></div>
</div>
<p>私たちは：class： <cite>〜sqlalchemy.orm.session.Session`に、データベースに残っているすべての変更を発行し、その間中進行していたトランザクションをコミットしたいと言っています。これを行うには、meth： `〜.Session.commit`を実行します。 ：class： `〜sqlalchemy.orm.session.Session`は、&amp;quot; ed &amp;quot;のパスワード変更のための</cite> <cite>UPDATE``文と、3つの新しい</cite> <cite>User``の</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>INSERT``文を発行します。 <a href="#id3"><span class="problematic" id="id4">`</span></a>オブジェクトを追加しました：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<div class='popup_sql'>UPDATE users SET password=? WHERE users.id = ?
(&#39;f8s7ccs&#39;, 1)
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
(&#39;wendy&#39;, &#39;Wendy Williams&#39;, &#39;foobar&#39;)
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
(&#39;mary&#39;, &#39;Mary Contrary&#39;, &#39;xxg527&#39;)
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
(&#39;fred&#39;, &#39;Fred Flinstone&#39;, &#39;blah&#39;)
COMMIT</div></pre></div>
</div>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.Session.commit`は、残りの変更をデータベースにフラッシュし、トランザクションをコミットします。セッションで参照される接続リソースが接続プールに返されるようになりました。このセッションでの後続の操作は**新しい**トランザクションで行われ、最初に必要なときに接続リソースを再度取得します。</p>
<p>以前は `` None``だったEdの `` id``属性を見ると、値は次のようになります：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">ed_user</span><span class="o">.</span><span class="n">id</span> 
<div class='popup_sql'>BEGIN (implicit)
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.id = ?
(1,)
</div><span class="mi">1</span></pre></div>
</div>
<p>：class： <cite>〜sqlalchemy.orm.session.Session`がデータベースに新しい行を挿入した後、新しく生成されたすべての識別子とデータベース生成されたデフォルトが、即座にまたは最初にロードされたアクセスによってインスタンス上で利用可能になります。この場合、新しいトランザクションが開始されたので、行全体がアクセス時に再ロードされました：meth： `〜.Session.commit</cite>。 SQLAlchemyは、デフォルトでは、新しいトランザクション内で最初にアクセスされたときに以前のトランザクションのデータをリフレッシュし、最新の状態が利用可能になります。再ロードのレベルは、doc： <a href="#id1"><span class="problematic" id="id2">`</span></a>/ orm / session`で説明されているように設定可能です。</p>
<div class="topic">
<p class="topic-title first">Session Object States</p>
<p>私たちの `` User``オブジェクトが：class： <cite>.Session`の外側から：class：</cite> .Session`の内部に移動して実際に挿入されるまで、それは4つの利用可能な&amp;quot;オブジェクト状態&amp;quot;  -  <strong>一時的</strong>、<strong>保留</strong>、<strong>永続</strong>。これらの状態とそれが意味することを常に意識しておくことは、常に良いアイデアです。簡単な概要については、ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>session_object_states`を必ず読んでください。</p>
</div>
</div>
<div class="section" id="rolling-back">
<h2>ロールバック<a class="headerlink" href="#rolling-back" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>：class： <cite>〜sqlalchemy.orm.session.Session`はトランザクション内で動作するので、変更をロールバックすることもできます。元に戻す2つの変更を加えましょう。 `</cite> ed_user``のユーザ名は `` Edwardo``に設定されます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">ed_user</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;Edwardo&#39;</span></pre></div>
</div>
<p>`` fake_user``という別の誤ったユーザを追加します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">fake_user</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fakeuser&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Invalid&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">fake_user</span><span class="p">)</span></pre></div>
</div>
<p>セッションを照会すると、セッションが現在のトランザクションにフラッシュされていることがわかります。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s1">&#39;Edwardo&#39;</span><span class="p">,</span> <span class="s1">&#39;fakeuser&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='popup_sql'>UPDATE users SET name=? WHERE users.id = ?
(&#39;Edwardo&#39;, 1)
INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
(&#39;fakeuser&#39;, &#39;Invalid&#39;, &#39;12345&#39;)
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name IN (?, ?)
(&#39;Edwardo&#39;, &#39;fakeuser&#39;)
</div><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;Edwardo&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fakeuser&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Invalid&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;12345&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
<p>ロールバックすると、 `` ed_user``の名前が `` ed``に戻り、 `` fake_user``がセッションから追い出されたことがわかります：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">rollback</span><span class="p">()</span>
<div class='popup_sql'>ROLLBACK
</div>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">ed_user</span><span class="o">.</span><span class="n">name</span>
<div class='popup_sql'>BEGIN (implicit)
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.id = ?
(1,)
</div><span class="sa">u</span><span class="s1">&#39;ed&#39;</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">fake_user</span> <span class="ow">in</span> <span class="n">session</span>
<span class="bp">False</span></pre></div>
</div>
<p>SELECTを発行すると、データベースに加えられた変更が示されます。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="s1">&#39;fakeuser&#39;</span><span class="p">]))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name IN (?, ?)
(&#39;ed&#39;, &#39;fakeuser&#39;)
</div><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
</div>
<div class="section" id="querying">
<span id="ormtutorial-querying"></span><h2>クエリ<a class="headerlink" href="#querying" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>A：class： <cite>〜sqlalchemy.orm.query.Query`オブジェクトは、：class：</cite>〜sqlalchemy.orm.session.Sessionの：class： <cite>〜sqlalchemy.orm.session.Session.query（）`メソッドを使って作成されます。 `。この関数は、可変数の引数を取ります。これは、クラスとクラスで実装された記述子の任意の組み合わせです。以下に、 `</cite> User``インスタンスを読み込む：class： <cite>〜sqlalchemy.orm.query.Query`を示します。反復的なコンテキストで評価すると、存在する `</cite> User``オブジェクトのリストが返されます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">instance</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">instance</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">instance</span><span class="o">.</span><span class="n">fullname</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users ORDER BY users.id
()
</div><span class="n">ed</span> <span class="n">Ed</span> <span class="n">Jones</span>
<span class="n">wendy</span> <span class="n">Wendy</span> <span class="n">Williams</span>
<span class="n">mary</span> <span class="n">Mary</span> <span class="n">Contrary</span>
<span class="n">fred</span> <span class="n">Fred</span> <span class="n">Flinstone</span></pre></div>
</div>
<p>：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.query.Query`は、引数としてORMインストルメントされた記述子も受け入れます。 ：class： <a href="#id3"><span class="problematic" id="id4">`</span></a>〜sqlalchemy.orm.session.Session.query（）`関数への引数として複数のクラスエンティティまたはカラムベースのエンティティが表現されるときはいつでも、返される結果はタプルとして表現されます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">fullname</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">fullname</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">fullname</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.name AS users_name,
        users.fullname AS users_fullname
FROM users
()
</div><span class="n">ed</span> <span class="n">Ed</span> <span class="n">Jones</span>
<span class="n">wendy</span> <span class="n">Wendy</span> <span class="n">Williams</span>
<span class="n">mary</span> <span class="n">Mary</span> <span class="n">Contrary</span>
<span class="n">fred</span> <span class="n">Fred</span> <span class="n">Flinstone</span></pre></div>
</div>
<p>：class： <cite>〜sqlalchemy.orm.query.Query`によって返されるタプルは、：class：</cite> .KeyedTuple`クラスによって提供される*名前付き*タプルであり、通常のPythonオブジェクトのように扱うことができます。名前は、属性の属性名とクラスのクラス名と同じです。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<span class="o">...</span>    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">User</span><span class="p">,</span> <span class="n">row</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
()
</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">ed</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">wendy</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mary&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Mary Contrary&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;xxg527&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">mary</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Fred Flinstone&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;blah&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="n">fred</span></pre></div>
</div>
<p>：meth： <cite>〜.ColumnElement.label`構造体を使用して個々の列式の名前を制御することができます。この構造体は、class：</cite> .ColumnElement`由来のオブジェクト、および1つにマップされたクラス属性（ `` User.name``など）：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="s1">&#39;name_label&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<span class="o">...</span>    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">name_label</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.name AS name_label
FROM users
()</div><span class="n">ed</span>
<span class="n">wendy</span>
<span class="n">mary</span>
<span class="n">fred</span></pre></div>
</div>
<p>：meth： <cite>〜.Session.query`の呼び出しに複数のエンティティが存在すると仮定して、</cite> <cite>User``のような完全なエンティティに与えられた名前は：func：</cite>〜.sqlalchemy.ormを使って制御できます。エイリアス化：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">user_alias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;user_alias&#39;</span><span class="p">)</span>

<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">user_alias</span><span class="p">,</span> <span class="n">user_alias</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<span class="o">...</span>    <span class="k">print</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">user_alias</span><span class="p">)</span>
<div class='popup_sql'>SELECT user_alias.id AS user_alias_id,
        user_alias.name AS user_alias_name,
        user_alias.fullname AS user_alias_fullname,
        user_alias.password AS user_alias_password
FROM users AS user_alias
()</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mary&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Mary Contrary&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;xxg527&#39;</span><span class="p">)</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Fred Flinstone&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;blah&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<p>：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.query.Query`を使った基本的な操作は、LIMITとOFFSETを発行することを含みます。最も簡単にはPythonの配列スライスを使用し、通常はORDER BYと組み合わせて使用​​します。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">u</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)[</span><span class="mi">1</span><span class="p">:</span><span class="mi">3</span><span class="p">]:</span>
<span class="o">...</span>    <span class="k">print</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users ORDER BY users.id
LIMIT ? OFFSET ?
(2, 1)</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mary&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Mary Contrary&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;xxg527&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<p>フィルタリング結果は、キーワード引数を使用する：func： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.query.Query.filter_by`を使用して実行します。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>             <span class="n">filter_by</span><span class="p">(</span><span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">):</span>
<span class="o">...</span>    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.name AS users_name FROM users
WHERE users.fullname = ?
(&#39;Ed Jones&#39;,)
</div><span class="n">ed</span></pre></div>
</div>
<p>... or：func： <cite>〜sqlalchemy.orm.query.Query.filter</cite>。より柔軟なSQL式言語構造を使用します。これらの関数を使うと、マップされたクラスのクラスレベルの属性を持つ通常のPython演算子を使用できます。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>             <span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">fullname</span><span class="o">==</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">):</span>
<span class="o">...</span>    <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.name AS users_name FROM users
WHERE users.fullname = ?
(&#39;Ed Jones&#39;,)
</div><span class="n">ed</span></pre></div>
</div>
<p>：class： <cite>〜sqlalchemy.orm.query.Query`オブジェクトは完全に** generative **です。つまり、ほとんどのメソッド呼び出しは新しい：class：</cite>〜sqlalchemy.orm.query.Query`オブジェクトを返します。追加される。たとえば、&amp;quot;ed &amp;quot;という名前のユーザーを&amp;quot;Ed Jones &amp;quot;というフルネームで照会するには、func： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.query.Query.filter`を2回呼び出すことができます。これは、 「AND」：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>          <span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;ed&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>          <span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">fullname</span><span class="o">==</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">):</span>
<span class="o">...</span>    <span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name = ? AND users.fullname = ?
(&#39;ed&#39;, &#39;Ed Jones&#39;)
</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<div class="section" id="common-filter-operators">
<h3>一般的なフィルタ演算子<a class="headerlink" href="#common-filter-operators" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>ここでは、以下で使用される最も一般的な演算子のいくつかの概要を示します：func： <cite>〜sqlalchemy.orm.query.Query.filter</cite>：</p>
<ul>
<li><p class="first">：meth： <cite>equals &amp;lt;.ColumnOperators .__ eq __&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ed&#39;</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <cite>not equals &amp;lt;.ColumnOperators .__ ne __&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="s1">&#39;ed&#39;</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <cite>LIKE &amp;lt;.ColumnOperators.like&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">d%&#39;</span><span class="p">))</span></pre></div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>.ColumnOperators.like`は、一部のバックエンドで大文字と小文字を区別せず、大文字と小文字を区別するLIKE演算子をレンダリングします。大文字と小文字を区別しない比較を保証するには、：meth： <a href="#id3"><span class="problematic" id="id4">`</span></a>.ColumnOperators.ilike`を使用します。</p>
</div>
</div></blockquote>
<ul>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>ILIKE &amp;lt;.ColumnOperators.ilike&amp;gt;`（大文字小文字を区別しないLIKE）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">ilike</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">d%&#39;</span><span class="p">))</span></pre></div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">ほとんどのバックエンドはILIKEを直接サポートしていません。そのために、：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>.ColumnOperators.ilike`演算子はLIKEと各オペランドに適用されるLOWER SQL関数を組み合わせた式をレンダリングします。</p>
</div>
</div></blockquote>
<ul>
<li><p class="first">：meth： <cite>IN &amp;lt;.ColumnOperators.in_&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">]))</span>

<span class="c1"># works with query objects too:</span>
<span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">(</span>
    <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">d%&#39;</span><span class="p">))</span>
<span class="p">))</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <cite>NOT IN &amp;lt;.ColumnOperators.notin_&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="o">~</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="s1">&#39;jack&#39;</span><span class="p">]))</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <cite>IS NULL &amp;lt;.ColumnOperators.is_&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># alternatively, if pep8/linters are a concern</span>
<span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">is_</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <cite>IS NOT NULL &amp;lt;.ColumnOperators.isnot&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)</span>

<span class="c1"># alternatively, if pep8/linters are a concern</span>
<span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">isnot</span><span class="p">(</span><span class="kc">None</span><span class="p">))</span></pre></div>
</div>
</li>
<li><p class="first">：func： <cite>AND &amp;lt;.sql.expression.and_&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># use and_()</span>
<span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">and_</span>
<span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">and_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">fullname</span> <span class="o">==</span> <span class="s1">&#39;Ed Jones&#39;</span><span class="p">))</span>

<span class="c1"># or send multiple expressions to .filter()</span>
<span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">fullname</span> <span class="o">==</span> <span class="s1">&#39;Ed Jones&#39;</span><span class="p">)</span>

<span class="c1"># or chain multiple filter()/filter_by() calls</span>
<span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">fullname</span> <span class="o">==</span> <span class="s1">&#39;Ed Jones&#39;</span><span class="p">)</span></pre></div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">必ず：func： <cite>.and_`とPythonの</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>and``演算子**を使用してください！</p>
</div>
</div></blockquote>
<ul>
<li><p class="first">：func： <cite>OR &amp;lt;.sql.expression.or_&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">or_</span>
<span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">or_</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;wendy&#39;</span><span class="p">))</span></pre></div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">必ず：func： <cite>.or_`とPythonの</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>or``演算子**を使用してください！</p>
</div>
</div></blockquote>
<ul>
<li><p class="first">：meth： <cite>MATCH &amp;lt;.ColumnOperators.match&amp;gt;</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">match</span><span class="p">(</span><span class="s1">&#39;wendy&#39;</span><span class="p">))</span></pre></div>
</div>
</li>
</ul>
<blockquote>
<div><div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">：meth： <cite>〜.ColumnOperators.match`はデータベース固有の</cite> <cite>MATCH``または</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>CONTAINS``関数を使います。その動作はバックエンドによって異なるため、SQLiteなどのバックエンドでは使用できません。</p>
</div>
</div></blockquote>
</div>
<div class="section" id="returning-lists-and-scalars">
<h3>リストとスカラーを返す<a class="headerlink" href="#returning-lists-and-scalars" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>いくつかのメソッド：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Query`はすぐにSQLを発行し、ロードされたデータベース結果を含む値を返します。簡単なツアーです：</p>
<ul>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.Query.all（）`はリストを返します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">d&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">query</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name LIKE ? ORDER BY users.id
(&#39;%ed&#39;,)
</div><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span>
      <span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Fred Flinstone&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;blah&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.Query.first（）`は1の制限を適用し、最初の結果をスカラーとして返します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">query</span><span class="o">.</span><span class="n">first</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name LIKE ? ORDER BY users.id
 LIMIT ? OFFSET ?
(&#39;%ed&#39;, 1, 0)
</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.Query.one（）`はすべての行を完全にフェッチします。結果に正確に1つのオブジェクトIDまたは複合行が存在しない場合は、エラーが発生します。複数の行が見つかりました：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="o">...</span>
<span class="n">MultipleResultsFound</span><span class="p">:</span> <span class="n">Multiple</span> <span class="n">rows</span> <span class="n">were</span> <span class="n">found</span> <span class="k">for</span> <span class="n">one</span><span class="p">()</span></pre></div>
</div>
<p>行が見つからない場合：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">user</span> <span class="o">=</span> <span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span> <span class="o">==</span> <span class="mi">99</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
<span class="o">...</span>
<span class="n">NoResultFound</span><span class="p">:</span> <span class="n">No</span> <span class="n">row</span> <span class="n">was</span> <span class="n">found</span> <span class="k">for</span> <span class="n">one</span><span class="p">()</span></pre></div>
</div>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.Query.one`メソッドは、&amp;quot;見つかったアイテムがありません&amp;quot;と&amp;quot;複数のアイテムが見つかりました&amp;quot;を別々に扱うことが期待されるシステムに最適です。結果が見つからない場合には&amp;quot;404 not found &amp;quot;を発生させたいが、複数の結果が見つかった場合にはアプリケーションエラーを発生させるRESTfulなWebサービスなど。</p>
</li>
<li><p class="first">：meth： <cite>〜.Query.one_or_none`は：meth：</cite>〜.Query.one`のようなものですが、結果が見つからなければエラーは発生しません。 `` None``を返すだけです。 ：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.Query.one`のように、しかし、複数の結果が見つかった場合は、エラーが発生します。</p>
</li>
<li><p class="first">：meth： <cite>〜.Query.scalar`は：meth：</cite>〜.Query.one`メソッドを呼び出し、成功するとその行の最初のカラムを返します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s1">&#39;ed&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>    <span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">query</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id
FROM users
WHERE users.name = ? ORDER BY users.id
(&#39;ed&#39;,)
</div><span class="mi">1</span></pre></div>
</div>
</li>
</ul>
</div>
<div class="section" id="using-textual-sql">
<span id="orm-tutorial-literal-sql"></span><h3>テキストSQLの使用<a class="headerlink" href="#using-textual-sql" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>リテラル文字列は：class： <cite>〜sqlalchemy.orm.query.Query`で柔軟に使用することができます。これは、ほとんどの適用可能なメソッドで受け入れられる：func：</cite>〜.expression.text`構文を使用して指定します。たとえば、：meth： <cite>〜sqlalchemy.orm.query.Query.filter（）`と：meth： `〜sqlalchemy.orm.query.Query.order_by（）</cite>：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">text</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>             <span class="nb">filter</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;id&lt;224&quot;</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>             <span class="n">order_by</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;id&quot;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">():</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE id&lt;224 ORDER BY id
()
</div><span class="n">ed</span>
<span class="n">wendy</span>
<span class="n">mary</span>
<span class="n">fred</span></pre></div>
</div>
<p>バインドパラメータは、コロンを使用して文字列ベースのSQLで指定できます。値を指定するには、：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.query.Query.params（）`メソッドを使用します。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">text</span><span class="p">(</span><span class="s2">&quot;id&lt;:value and name=:name&quot;</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>     <span class="n">params</span><span class="p">(</span><span class="n">value</span><span class="o">=</span><span class="mi">224</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE id&lt;? and name=? ORDER BY users.id
(224, &#39;fred&#39;)
</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Fred Flinstone&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;blah&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<p>完全な文字列ベースの文を使用するには、完全な文を表すa：func： <cite>.text`構文を：meth：</cite>〜sqlalchemy.orm.query.Query.from_statement（） <a href="#id1"><span class="problematic" id="id2">`</span></a>に渡すことができます。追加の指定子がなければ、文字列SQLの列は、名前に基づいてモデル列に一致します。たとえば、以下のように、すべての列のロードを表すアスタリスクを使用します。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">from_statement</span><span class="p">(</span>
<span class="o">...</span>                     <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM users where name=:name&quot;</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>                     <span class="n">params</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT * FROM users where name=?
(&#39;ed&#39;,)
</div><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
<p>nameに一致する列は単純なケースでは機能しますが、重複する列名を含む複雑なステートメントを扱う場合、または特定の名前に簡単に一致しない匿名化されたORM構文を使用する場合は扱いにくくなる可能性があります。さらに、マッピングされた列には、結果行を処理する際に必要な型指定の動作があります。これらの場合、：func： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.expression.text`構造体は、テキスト形式のSQLをCoreまたはORMでマップされた列式に位置的にリンクすることができます。 ：meth： <a href="#id3"><span class="problematic" id="id4">`</span></a>.TextClause.columns`メソッドにポジション引数としてカラム式を渡すことでこれを実現できます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT name, id, fullname, password &quot;</span>
<span class="o">...</span>             <span class="s2">&quot;FROM users where name=:name&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">password</span><span class="p">)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">from_statement</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT name, id, fullname, password FROM users where name=?
(&#39;ed&#39;,)
</div><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
<div class="versionadded">
<p><span class="versionmodified">バージョン 1.1 で追加: </span>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>.TextClause.columns`メソッドは、SQL文中で列名を一致させたり、一意にする必要性を排除して、プレーンテキストのSQL結果セットと位置的にマッチする列式を受け入れるようになりました。</p>
</div>
<p>a：func： <cite>〜.expression.text`構造から選択すると、：class：</cite> .Query`は引き続き返される列とエンティティを指定することができます。 `` query（User） <a href="#id1"><span class="problematic" id="id2">``</span></a>の代わりに、他の場合と同様に列を個別に求めることもできます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">text</span><span class="p">(</span><span class="s2">&quot;SELECT name, id FROM users where name=:name&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">stmt</span><span class="o">.</span><span class="n">columns</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>          <span class="n">from_statement</span><span class="p">(</span><span class="n">stmt</span><span class="p">)</span><span class="o">.</span><span class="n">params</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT name, id FROM users where name=?
(&#39;ed&#39;,)
</div><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;ed&#39;</span><span class="p">)]</span></pre></div>
</div>
<div class="admonition seealso">
<p class="first admonition-title">参考</p>
<p class="last">：ref： <cite>sqlexpression_text</cite>  - ：func：` .text`構造体は、コアのみのクエリの観点から説明されています。</p>
</div>
</div>
<div class="section" id="counting">
<h3>カウント<a class="headerlink" href="#counting" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>：class： <cite>〜sqlalchemy.orm.query.Query`には、meth：</cite>〜sqlalchemy.orm.query.Query.count（） <a href="#id1"><span class="problematic" id="id2">`</span></a>と呼ばれる便利な計数方法が含まれています：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%e</span><span class="s1">d&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<div class='popup_sql'>SELECT count(*) AS count_1
FROM (SELECT users.id AS users_id,
                users.name AS users_name,
                users.fullname AS users_fullname,
                users.password AS users_password
FROM users
WHERE users.name LIKE ?) AS anon_1
(&#39;%ed&#39;,)
</div><span class="mi">2</span></pre></div>
</div>
<div class="sidebar">
<p class="first sidebar-title">Counting on <code class="docutils literal notranslate"><span class="pre">count()</span></code></p>
<p class="last">：meth： <cite>.Query.count`は、既存のクエリの周りにサブクエリが必要かどうかを推測しようとすると非常に複雑なメソッドでしたが、いくつかのエキゾチックなケースでは正しいことはしませんでした。これで、毎回簡単なサブクエリが使用されるようになったので、2行しかなく、常に正しい答えが返されます。特定の文がサブクエリの存在を絶対に許さない場合は、 `</cite> func.count（） <a href="#id1"><span class="problematic" id="id2">``</span></a>を使用します。</p>
</div>
<p>：meth： <cite>〜.Query.count（）`メソッドは、SQL文が返す行の数を決定するために使用されます。上記の生成されたSQLを見ると、SQLAlchemyは、それが照会しているものを常にサブクエリに配置し、そこから行を数えます。場合によっては、これは単純な `</cite> SELECT count（*）FROM table``に減らすことができますが、SQLAlchemyの現代版は、より明示的な手段を使って正確なSQLを発行できるので、これがいつ適切かを推測しようとしません。</p>
<p>&amp;quot;カウントするもの&amp;quot;を特に指定する必要がある場合は、&amp;quot;count &amp;quot;関数を直接指定することができます： `` func.count（） <a href="#id1"><span class="problematic" id="id2">``</span></a>：attr： <a href="#id3"><span class="problematic" id="id4">`</span></a>〜 sqlalchemy.sql.expression.func`構造体です。以下では、別々のユーザー名の数を返すために使用します。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">func</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">),</span> <span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">group_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT count(users.name) AS count_1, users.name AS users_name
FROM users GROUP BY users.name
()
</div><span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;ed&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;fred&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;mary&#39;</span><span class="p">),</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="sa">u</span><span class="s1">&#39;wendy&#39;</span><span class="p">)]</span></pre></div>
</div>
<p>単純な `` SELECT count（*）FROM table``を達成するために、次のように適用することができます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<div class='popup_sql'>SELECT count(?) AS count_1
FROM users
(&#39;*&#39;,)
</div><span class="mi">4</span></pre></div>
</div>
<p>：meth： <cite>〜.Query.select_from`の使用法は、</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>User``主キーの観点からカウントを直接表現すると削除できます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">))</span><span class="o">.</span><span class="n">scalar</span><span class="p">()</span>
<div class='popup_sql'>SELECT count(users.id) AS count_1
FROM users
()
</div><span class="mi">4</span></pre></div>
</div>
</div>
</div>
<div class="section" id="building-a-relationship">
<span id="orm-tutorial-relationship"></span><h2>関係を構築する<a class="headerlink" href="#building-a-relationship" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>`` User``に関連する2番目のテーブルがどのようにマップされ照会されるかを考えてみましょう。 Googleシステムのユーザーは、ユーザー名に関連付けられた任意の数の電子メールアドレスを保存できます。これは、「ユーザー」から電子メールアドレスを格納する新しいテーブルへの基本的な1対多の関連付けを意味します。これを「アドレス」と呼びます。宣言型を使用して、このテーブルをマッピングされたクラス `` Address``とともに定義します：</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="kn">import</span> <span class="n">ForeignKey</span>
<span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">relationship</span>

<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;addresses&#39;</span>
<span class="gp">... </span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">email_address</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.id&#39;</span><span class="p">))</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">user</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s2">&quot;&lt;Address(email_address=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_address</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span>
<span class="gp">... </span>    <span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">order_by</span><span class="o">=</span><span class="n">Address</span><span class="o">.</span><span class="n">id</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;user&quot;</span><span class="p">)</span></pre></div>
</div>
<p>上記のクラスは：class： <cite>.ForeignKey`コンストラクトを導入しています。これは：class：</cite> .Column`に適用されるディレクティブで、このカラムの値は以下のようになります：term： <cite>constrained`カラム。これは、リレーショナルデータベースの中核的機能であり、他の方法では未接続のテーブルコレクションを豊富な重複関係に変換する&amp;quot;グルー&amp;quot;です。 ：class： `.ForeignKey`は、</cite> <cite>addresses.user_id``カラムの値を</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>users.id``カラムの値、つまりプライマリキーに制限する必要があることを表しています。</p>
<p>：func： <cite>.relationship`と呼ばれる第2の指示文は、</cite> <cite>Address``クラス自身が属性</cite> <cite>Address.user``を使用して</cite> <cite>User``クラスにリンクされるべきであることをORMに伝えます。 ：func： `.relationship`は、このリンクの性質を判断するために2つのテーブル間の外部キー関係を使用し、</cite> <cite>Address.user``がterm：</cite> many to one`になることを決定します。追加の：func： <cite>.relationship`ディレクティブは、</cite> <cite>User.addresses``属性の</cite> <cite>User``マッピングされたクラスに置かれます。 ：func： `.relationship`ディレクティブの両方で、パラメータ：paramref：</cite> .relationship.back_populates`は補完的な属性名を参照するために割り当てられます。そうすることによって、func： <cite>.relationship &amp;#39;は逆に表現された同じ関係について知的な決定を下すことができます。 `</cite> User.address``は `` Address``インスタンスのリストを参照しています。</p>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">：paramref： <cite>.relationship.back_populates`パラメータはparamref：</cite> .relationship.backref`という非常に一般的なSQLAlchemy機能の新しいバージョンです。 ：paramref： <a href="#id1"><span class="problematic" id="id2">`</span></a>.relationship.backref`パラメータはどこにもなく、常に利用可能です！ ：paramref： <a href="#id3"><span class="problematic" id="id4">`</span></a>.relationship.back_populates`はもう少し冗長で扱いやすいことを除いて同じものです。トピック全体の概要は、ref： <a href="#id5"><span class="problematic" id="id6">`</span></a>relationships_backref`を参照してください。</p>
</div>
<p>多対1の関係の逆は、常に：term： <cite>one to many`です。利用可能な完全なカタログ：func： `.relationship`設定は：ref：</cite> relationship_patterns`です。</p>
<p>`` Address.user``と `` User.addresses``という2つの補完関係は、a：term： <a href="#id1"><span class="problematic" id="id2">`</span></a>双方向関係 &amp;#39;と呼ばれ、SQLAlchemy ORMの重要な機能です。セクション：ref： <a href="#id3"><span class="problematic" id="id4">`</span></a>relationships_backref`は&amp;quot; backref &amp;quot;機能について詳しく説明します。</p>
<p>Declarativeシステムが使用されていると仮定すると、リモートクラスに関係する：func： <cite>.relationship`の引数は、文字列を使って指定することができます。すべてのマッピングが完了したら、これらの文字列は実際の引数を生成するためにPython式として評価されます。上記の場合、 `</cite> User``クラスです。この評価中に許可される名前には、とりわけ、宣言されたベースに関して作成されたすべてのクラスの名前が含まれます。</p>
<p>引数のスタイルの詳細については、docstring for：func： <a href="#id1"><span class="problematic" id="id2">`</span></a>.relationship`を参照してください。</p>
<div class="topic">
<p class="topic-title first">Did you know ?</p>
<ul class="simple">
<li>ほとんどの（ただしすべてではありませんが）リレーショナル・データベースのFOREIGN KEY制約は、主キー列またはUNIQUE制約を持つ列にのみリンクできます。</li>
<li>複数の列の主キーを参照し、複数の列を持つFOREIGN KEY制約は&amp;quot;複合外部キー&amp;quot;として知られています。これらの列のサブセットを参照することもできます。</li>
<li>FOREIGN KEY列は、参照される列または行の変更に応じて自動的に更新されます。これは、CASCADE <a href="#id1"><span class="problematic" id="id2">*</span></a>参照アクション*と呼ばれ、リレーショナルデータベースの組み込み関数です。</li>
<li>FOREIGN KEYはそれ自身のテーブルを参照できます。これは&amp;quot;自己参照&amp;quot;外部キーと呼ばれます。</li>
<li><a href="#id1"><span class="problematic" id="id2">`</span></a>Foreign Key  - 外部キーについての詳細はこちら -  Wikipedia &lt;<a class="reference external" href="http://en.wikipedia.org/wiki/Foreign_key">http://en.wikipedia.org/wiki/Foreign_key</a>&gt; <a href="#id3"><span class="problematic" id="id4">`</span></a>_。</li>
</ul>
</div>
<p>データベースに `` addresses``テーブルを作成する必要がありますので、既に作成されているテーブルをスキップして、メタデータから別のCREATEを発行します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<div class='popup_sql'>PRAGMA...
CREATE TABLE addresses (
    id INTEGER NOT NULL,
    email_address VARCHAR NOT NULL,
    user_id INTEGER,
    PRIMARY KEY (id),
     FOREIGN KEY(user_id) REFERENCES users (id)
)
()
COMMIT</div></pre></div>
</div>
</div>
<div class="section" id="working-with-related-objects">
<h2>関連オブジェクトの操作<a class="headerlink" href="#working-with-related-objects" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>今、 `` User``を作成すると、空の `` addresses``コレクションが表示されます。ここでは、セットや辞書などのさまざまなコレクション型が可能です（詳細は：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>custom_collections`を参照してください）が、デフォルトでコレクションはPythonリストです。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span> <span class="o">=</span> <span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span><span class="o">.</span><span class="n">addresses</span>
<span class="p">[]</span></pre></div>
</div>
<p>`` User``オブジェクトに `` Address``オブジェクトを自由に追加することができます。この場合、完全なリストを直接割り当てるだけです：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span><span class="o">.</span><span class="n">addresses</span> <span class="o">=</span> <span class="p">[</span>
<span class="o">...</span>                 <span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">),</span>
<span class="o">...</span>                 <span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">)]</span></pre></div>
</div>
<p>双方向関係を使用する場合、一方向に追加された要素は自動的に他方の方向に表示されます。この動作は、変更時に発生するイベントに基づいて行われ、PythonではSQLを使用せずに評価されます。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span><span class="o">.</span><span class="n">addresses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">)</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span><span class="o">.</span><span class="n">addresses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">user</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<p>`` Jack Bean``をデータベースに追加してコミットしましょう。対応する `` addresses``コレクションの2つの `` Address``メンバーだけでなく `` jack``も**カスケード**：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">jack</span><span class="p">)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
<div class='popup_sql'>INSERT INTO users (name, fullname, password) VALUES (?, ?, ?)
(&#39;jack&#39;, &#39;Jack Bean&#39;, &#39;gjffdd&#39;)
INSERT INTO addresses (email_address, user_id) VALUES (?, ?)
(&#39;jack@google.com&#39;, 5)
INSERT INTO addresses (email_address, user_id) VALUES (?, ?)
(&#39;j25@yahoo.com&#39;, 5)
COMMIT</div></pre></div>
</div>
<p>ジャックを照会すると、ジャックだけが戻ってくる。 JackのアドレスにはまだSQLは発行されていません：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span> <span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<div class='popup_sql'>BEGIN (implicit)
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name = ?
(&#39;jack&#39;,)

</div><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<p>`` addresses``コレクションを見てみましょう。 SQLの監視：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span><span class="o">.</span><span class="n">addresses</span>
<div class='popup_sql'>SELECT addresses.id AS addresses_id,
        addresses.email_address AS
        addresses_email_address,
        addresses.user_id AS addresses_user_id
FROM addresses
WHERE ? = addresses.user_id ORDER BY addresses.id
(5,)
</div><span class="p">[</span><span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
<p>`` addresses``コレクションにアクセスすると、SQLが突然発行されました。これは：term： <cite>lazy loading`関係の例です。 `</cite> addresses``コレクションがロードされ、通常のリストのように動作します。このコレクションの読み込みを少しでも最適化する方法について説明します。</p>
</div>
<div class="section" id="querying-with-joins">
<span id="ormtutorial-joins"></span><h2>ジョインを使用したクエリ<a class="headerlink" href="#querying-with-joins" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ここでは2つのテーブルがあるので、class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Query`のいくつかの機能を紹介します。具体的には両方のテーブルを同時に扱うクエリを作成する方法です。 <a href="#id3"><span class="problematic" id="id4">`</span></a>SQL JOINに関するWikipediaのページ&lt;<a class="reference external" href="http://en.wikipedia.org/wiki/Join_%28SQL%29">http://en.wikipedia.org/wiki/Join_%28SQL%29</a>&gt; <a href="#id5"><span class="problematic" id="id6">`</span></a>_では、ここで説明するいくつかの技術を結合するための良い紹介が提供されています。</p>
<p>`` User``と `` Address``の単純な暗黙的な結合を構築するために、：meth： <cite>.Query.filter（）`を使って関連する列をまとめてみましょう。以下では、このメソッドを使用して `</cite> User``と `` Address``エンティティを一度に読み込みます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                     <span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                     <span class="nb">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="o">==</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                     <span class="nb">all</span><span class="p">():</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">u</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password,
        addresses.id AS addresses_id,
        addresses.email_address AS addresses_email_address,
        addresses.user_id AS addresses_user_id
FROM users, addresses
WHERE users.id = addresses.user_id
        AND addresses.email_address = ?
(&#39;jack@google.com&#39;,)
</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<p>一方、実際のSQL JOIN構文は、：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Query.join`メソッドを使用すると最も簡単に実現できます。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>         <span class="nb">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="o">==</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>         <span class="nb">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users JOIN addresses ON users.id = addresses.user_id
WHERE addresses.email_address = ?
(&#39;jack@google.com&#39;,)
</div><span class="p">[</span><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
<p>：meth： <cite>.Query.join`は、</cite> <cite>User``と</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>Address``の間にどのように結合するかを知っています。外部キーがない場合、またはいくつかの場合、次のいずれかの形式を使用すると：meth： <a href="#id3"><span class="problematic" id="id4">`</span></a>.Query.join`がうまく動作します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span>    <span class="c1"># explicit condition</span>
<span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>                       <span class="c1"># specify relationship from left to right</span>
<span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>              <span class="c1"># same, with explicit target</span>
<span class="n">query</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="s1">&#39;addresses&#39;</span><span class="p">)</span>                          <span class="c1"># same, using a string</span></pre></div>
</div>
<p>予想通り、：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.Query.outerjoin`関数を使用して、同じ考え方を&amp;quot; outer &amp;quot;結合に使用します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">outerjoin</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span>   <span class="c1"># LEFT OUTER JOIN</span></pre></div>
</div>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.Query.join`のリファレンスドキュメントには、このメソッドで受け入れられる呼び出しスタイルの詳細と例が含まれています。 ：meth： <a href="#id3"><span class="problematic" id="id4">`</span></a>〜.Query.join`は、SQLの流暢なアプリケーションの使用の中心にある重要なメソッドです。</p>
<div class="topic">
<p class="topic-title first">What does <a class="reference internal" href="query.html#sqlalchemy.orm.query.Query" title="sqlalchemy.orm.query.Query"><code class="xref py py-class docutils literal notranslate"><span class="pre">Query</span></code></a> select from if there's multiple entities?</p>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Query.join`メソッドは、通常、エンティティのリストの中の一番左のアイテム**から、ON句が省略されたとき、またはON句がプレーンなSQL式である場合に参加します。 JOINのリスト内の最初のエンティティを制御するには、：meth： <a href="#id3"><span class="problematic" id="id4">`</span></a>.Query.select_from`メソッドを使用します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">select_from</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">User</span><span class="p">)</span></pre></div>
</div>
</div>
<div class="section" id="using-aliases">
<span id="ormtutorial-aliases"></span><h3>エイリアスの使用<a class="headerlink" href="#using-aliases" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>複数のテーブルにまたがってクエリを実行する場合、同じテーブルを複数回参照する必要がある場合、SQLでは通常、そのテーブルの他のオカレンスと区別できるように、テーブルに別名を*別名*として指定する必要があります。 ：class： <cite>〜sqlalchemy.orm.query.Query`は：attr：</cite>〜sqlalchemy.orm.aliased`構造体を使ってこれを最も明示的にサポートします。以下では、2つの異なる電子メールアドレスを同時に持つユーザを見つけるために、 `` Address``エンティティに2回参加します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">aliased</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">adalias1</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">adalias2</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">username</span><span class="p">,</span> <span class="n">email1</span><span class="p">,</span> <span class="n">email2</span> <span class="ow">in</span> \
<span class="o">...</span>     <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">adalias1</span><span class="o">.</span><span class="n">email_address</span><span class="p">,</span> <span class="n">adalias2</span><span class="o">.</span><span class="n">email_address</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>     <span class="n">join</span><span class="p">(</span><span class="n">adalias1</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>     <span class="n">join</span><span class="p">(</span><span class="n">adalias2</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>     <span class="nb">filter</span><span class="p">(</span><span class="n">adalias1</span><span class="o">.</span><span class="n">email_address</span><span class="o">==</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>     <span class="nb">filter</span><span class="p">(</span><span class="n">adalias2</span><span class="o">.</span><span class="n">email_address</span><span class="o">==</span><span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">username</span><span class="p">,</span> <span class="n">email1</span><span class="p">,</span> <span class="n">email2</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.name AS users_name,
        addresses_1.email_address AS addresses_1_email_address,
        addresses_2.email_address AS addresses_2_email_address
FROM users JOIN addresses AS addresses_1
        ON users.id = addresses_1.user_id
JOIN addresses AS addresses_2
        ON users.id = addresses_2.user_id
WHERE addresses_1.email_address = ?
        AND addresses_2.email_address = ?
(&#39;jack@google.com&#39;, &#39;j25@yahoo.com&#39;)
</div><span class="n">jack</span> <span class="n">jack</span><span class="nd">@google.com</span> <span class="n">j25</span><span class="nd">@yahoo.com</span></pre></div>
</div>
</div>
<div class="section" id="using-subqueries">
<h3>サブクエリの使用<a class="headerlink" href="#using-subqueries" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>：class： <cite>〜sqlalchemy.orm.query.Query`はサブクエリとして使用できる文を生成するのに適しています。 `</cite> User``オブジェクトを、各ユーザが持つ `` Address``レコードの数と一緒に読み込みたいとします。このようにSQLを生成する最善の方法は、ユーザーIDでグループ化されたアドレスの数を取得し、親にJOINすることです。この例では、LEFT OUTER JOINを使用して、アドレスを持たないユーザーに対して行を返すようにします。例：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">SELECT</span> <span class="n">users</span><span class="o">.*</span><span class="p">,</span> <span class="n">adr_count</span><span class="o">.</span><span class="n">address_count</span> <span class="n">FROM</span> <span class="n">users</span> <span class="n">LEFT</span> <span class="n">OUTER</span> <span class="n">JOIN</span>
    <span class="p">(</span><span class="n">SELECT</span> <span class="n">user_id</span><span class="p">,</span> <span class="n">count</span><span class="p">(</span><span class="o">*</span><span class="p">)</span> <span class="n">AS</span> <span class="n">address_count</span>
        <span class="n">FROM</span> <span class="n">addresses</span> <span class="n">GROUP</span> <span class="n">BY</span> <span class="n">user_id</span><span class="p">)</span> <span class="n">AS</span> <span class="n">adr_count</span>
    <span class="n">ON</span> <span class="n">users</span><span class="o">.</span><span class="n">id</span><span class="o">=</span><span class="n">adr_count</span><span class="o">.</span><span class="n">user_id</span></pre></div>
</div>
<p>：class： <cite>〜sqlalchemy.orm.query.Query`を使用して、内部からこのようなステートメントを作成します。 `</cite> statement``アクセサは、特定のクラスによって生成された文を表すSQL式を返します：class： <cite>〜sqlalchemy.orm.query.Query</cite>  -  a：func：<cite>〜.expression.select`構造体のインスタンスです。これらはref： `sqlexpression_toplevel</cite> ::に記述されています。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="k">import</span> <span class="n">func</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">stmt</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="p">,</span> <span class="n">func</span><span class="o">.</span><span class="n">count</span><span class="p">(</span><span class="s1">&#39;*&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="gp">... </span>        <span class="n">label</span><span class="p">(</span><span class="s1">&#39;address_count&#39;</span><span class="p">))</span><span class="o">.</span>\
<span class="gp">... </span>        <span class="n">group_by</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">subquery</span><span class="p">()</span></pre></div>
</div>
<p>`` func``キーワードはSQL関数を生成し、class： <cite>〜sqlalchemy.orm.query.Query`の</cite> <cite>subquery（）</cite> <cite>メソッドはエイリアス内に埋め込まれたSELECT文を表すSQL式構造を生成します実際には `</cite> query.statement.alias（） <a href="#id1"><span class="problematic" id="id2">``</span></a>の略です）。</p>
<p>ステートメントを取得すると、このチュートリアルの始めで `` users``のために作成したものなど、class： <cite>〜sqlalchemy.schema.Table`のように動作します。文の列は、 `</cite> c``という属性を使ってアクセスできます。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">u</span><span class="p">,</span> <span class="n">count</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">stmt</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">address_count</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>     <span class="n">outerjoin</span><span class="p">(</span><span class="n">stmt</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="o">==</span><span class="n">stmt</span><span class="o">.</span><span class="n">c</span><span class="o">.</span><span class="n">user_id</span><span class="p">)</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">u</span><span class="p">,</span> <span class="n">count</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password,
        anon_1.address_count AS anon_1_address_count
FROM users LEFT OUTER JOIN
    (SELECT addresses.user_id AS user_id, count(?) AS address_count
    FROM addresses GROUP BY addresses.user_id) AS anon_1
    ON users.id = anon_1.user_id
ORDER BY users.id
(&#39;*&#39;,)
</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Ed Jones&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;f8s7ccs&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="bp">None</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="bp">None</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;mary&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Mary Contrary&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;xxg527&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="bp">None</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;fred&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Fred Flinstone&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;blah&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="bp">None</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span> <span class="mi">2</span></pre></div>
</div>
</div>
<div class="section" id="selecting-entities-from-subqueries">
<h3>サブクエリからエンティティを選択する<a class="headerlink" href="#selecting-entities-from-subqueries" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>上の例では、サブクエリの列を含む結果を選択しました。サブクエリをエンティティにマッピングする場合はどうなりますか？このため、マップされたクラスの&amp;quot;エイリアス&amp;quot;をサブクエリに関連付けるには、 `` aliased（） <a href="#id1"><span class="problematic" id="id2">``</span></a>を使います：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                 <span class="nb">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span> <span class="o">!=</span> <span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                 <span class="n">subquery</span><span class="p">()</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">adalias</span> <span class="o">=</span> <span class="n">aliased</span><span class="p">(</span><span class="n">Address</span><span class="p">,</span> <span class="n">stmt</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">user</span><span class="p">,</span> <span class="n">address</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">adalias</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>         <span class="n">join</span><span class="p">(</span><span class="n">adalias</span><span class="p">,</span> <span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">user</span><span class="p">)</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">address</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.id AS users_id,
            users.name AS users_name,
            users.fullname AS users_fullname,
            users.password AS users_password,
            anon_1.id AS anon_1_id,
            anon_1.email_address AS anon_1_email_address,
            anon_1.user_id AS anon_1_user_id
FROM users JOIN
    (SELECT addresses.id AS id,
            addresses.email_address AS email_address,
            addresses.user_id AS user_id
    FROM addresses
    WHERE addresses.email_address != ?) AS anon_1
    ON users.id = anon_1.user_id
(&#39;j25@yahoo.com&#39;,)
</div><span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
</div>
<div class="section" id="using-exists">
<h3>EXISTSの使用<a class="headerlink" href="#using-exists" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>SQLのEXISTSキーワードは、指定された式に行が含まれる場合はTrueを返すブール演算子です。これは、ジョインの代わりに多くのシナリオで使用され、関連する表に対応する行を持たない行の検索にも役立ちます。</p>
<p>明示的なEXISTS構文があります。これは次のようになります。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy.sql</span> <span class="kn">import</span> <span class="n">exists</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">stmt</span> <span class="o">=</span> <span class="n">exists</span><span class="p">()</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user_id</span><span class="o">==</span><span class="n">User</span><span class="o">.</span><span class="n">id</span><span class="p">)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">stmt</span><span class="p">):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.name AS users_name
FROM users
WHERE EXISTS (SELECT *
FROM addresses
WHERE addresses.user_id = users.id)
()
</div><span class="n">jack</span></pre></div>
</div>
<p>：class： <cite>〜sqlalchemy.orm.query.Query`は、EXISTSを自動的に使用するいくつかの演算子を備えています。上記の文は、 `</cite> User.addresses``の関係に沿って以下のように表現できます：meth： <cite>〜.RelationshipProperty.Comparator.any</cite>：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>         <span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">any</span><span class="p">()):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.name AS users_name
FROM users
WHERE EXISTS (SELECT 1
FROM addresses
WHERE users.id = addresses.user_id)
()
</div><span class="n">jack</span></pre></div>
</div>
<p>：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.RelationshipProperty.Comparator.any`は、一致した行を制限するためにも基準をとります：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="ow">in</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>     <span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="o">.</span><span class="n">like</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">%g</span><span class="s1">oogle%&#39;</span><span class="p">))):</span>
<span class="o">...</span>     <span class="k">print</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
<div class='popup_sql'>SELECT users.name AS users_name
FROM users
WHERE EXISTS (SELECT 1
FROM addresses
WHERE users.id = addresses.user_id AND addresses.email_address LIKE ?)
(&#39;%google%&#39;,)
</div><span class="n">jack</span></pre></div>
</div>
<p>：meth： <cite>〜.RelationshipProperty.Comparator.has`は多対1の関係のために：meth：</cite>〜。RelationhipProperty.Comparator.any`と同じ演算子です（ここでも <a href="#id1"><span class="problematic" id="id2">``</span></a>〜 <a href="#id3"><span class="problematic" id="id4">``</span></a>演算子に注意してください。 &amp;quot;NOT &amp;quot;）：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>         <span class="nb">filter</span><span class="p">(</span><span class="o">~</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;jack&#39;</span><span class="p">))</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT addresses.id AS addresses_id,
        addresses.email_address AS addresses_email_address,
        addresses.user_id AS addresses_user_id
FROM addresses
WHERE NOT (EXISTS (SELECT 1
FROM users
WHERE users.id = addresses.user_id AND users.name = ?))
(&#39;jack&#39;,)
</div><span class="p">[]</span></pre></div>
</div>
</div>
<div class="section" id="common-relationship-operators">
<h3>共通関係演算子<a class="headerlink" href="#common-relationship-operators" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>リレーションシップに基づいて構築されたすべての演算子があります。各演算子は、APIドキュメントにリンクされています。このドキュメントには、使用法と動作の詳細が含まれています。</p>
<ul>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜。RelationhipProperty.Comparator .__ eq__`（多対1の&amp;quot; equals &amp;quot;比較）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="n">someuser</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜。RelationhipProperty.Comparator .__ ne__`（多対1の&amp;quot;等しくない &amp;quot;比較）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span> <span class="o">!=</span> <span class="n">someuser</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p class="first">IS NULL（多対1比較、：meth： <cite>〜.RelationshipProperty.Comparator .__ eq__</cite>）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span> <span class="o">==</span> <span class="kc">None</span><span class="p">)</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜。RelationhipProperty.Comparator.contains`（1対多のコレクションで使用される）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">someaddress</span><span class="p">))</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜。RelationhipProperty.Comparator.any`（コレクションに使用）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">email_address</span> <span class="o">==</span> <span class="s1">&#39;bar&#39;</span><span class="p">))</span>

<span class="c1"># also takes keyword arguments:</span>
<span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;bar&#39;</span><span class="p">))</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜.RelationshipProperty.Comparator.has`（スカラー参照に使用）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">query</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span><span class="o">.</span><span class="n">has</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;ed&#39;</span><span class="p">))</span></pre></div>
</div>
</li>
<li><p class="first">：meth： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Query.with_parent`（任意の関係に使用）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">with_parent</span><span class="p">(</span><span class="n">someuser</span><span class="p">,</span> <span class="s1">&#39;addresses&#39;</span><span class="p">)</span></pre></div>
</div>
</li>
</ul>
</div>
</div>
<div class="section" id="eager-loading">
<h2>Eager Loading<a class="headerlink" href="#eager-loading" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>前述のように、 `` User``の `` User.addresses``コレクションにアクセスしてSQLを発行したときに、用語：遅延読み込み操作を示したことを思い出してください。クエリの数を大幅に削減したい場合（多くの場合、劇的に）、クエリ操作に：term： <cite>eager load &amp;#39;を適用できます。 SQLAlchemyには3つのタイプのeager loadingがあり、そのうち2つは自動であり、3つ目はカスタムの基準です。これらの3つは、通常：term： `query options`という関数で呼び出されます。これは、：meth：</cite> .Query.optionsを介して、さまざまな属性をロードする方法について、class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Query`に追加の指示を与えます。 <a href="#id3"><span class="problematic" id="id4">`</span></a>メソッド。</p>
<div class="section" id="subquery-load">
<h3>サブクエリのロード<a class="headerlink" href="#subquery-load" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>この場合、 `` User.addresses``が熱心に読み込まれるべきであることを示したいと思います。オブジェクトのセットと関連するコレクションのロードには、func： <a href="#id1"><span class="problematic" id="id2">`</span></a>.orm.subqueryload`オプションがあります。このオプションは、ロードされたばかりの結果に関連付けられたコレクションを完全にロードする2番目のSELECT文を発行します。 &amp;quot;サブクエリ&amp;quot;という名前は、：class： <a href="#id3"><span class="problematic" id="id4">`</span></a>.Query`を介して直接生成されたSELECT文が再利用され、関連するテーブルに対してSELECTにサブクエリとして埋め込まれているという事実に由来します。これはやや精巧ですが、使い方はとても簡単です：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">subqueryload</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                 <span class="n">options</span><span class="p">(</span><span class="n">subqueryload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>                 <span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name = ?
(&#39;jack&#39;,)
SELECT addresses.id AS addresses_id,
        addresses.email_address AS addresses_email_address,
        addresses.user_id AS addresses_user_id,
        anon_1.users_id AS anon_1_users_id
FROM (SELECT users.id AS users_id
    FROM users WHERE users.name = ?) AS anon_1
JOIN addresses ON anon_1.users_id = addresses.user_id
ORDER BY anon_1.users_id, addresses.id
(&#39;jack&#39;,)
</div><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span><span class="o">.</span><span class="n">addresses</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">：meth： <cite>.Query.first</cite>、：meth：` .Query.limit`や：meth： <cite>.Query.offset`のような制限付きで使用された場合：func：</cite> .subqueryload`：meth：正確な結果を保証するために、一意の列に <a href="#id1"><span class="problematic" id="id2">`</span></a>.Query.order_by`を追加します。参照：ref： <a href="#id3"><span class="problematic" id="id4">`</span></a>subqueryload_ordering`を参照してください。</p>
</div>
</div>
<div class="section" id="joined-load">
<h3>結合荷重<a class="headerlink" href="#joined-load" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>他の自動eagerローディング関数はよりよく知られており、func： <cite>.orm.joinedload`と呼ばれています。このスタイルの読み込みでは、デフォルトでLEO OUTER JOINというJOINが発行され、リードオブジェクトと関連するオブジェクトまたはコレクションがワンステップでロードされます。このように同じ `</cite> addresses``コレクションをロードすることを示します.-実際に `` jack``の `` User.addresses``コレクションが実際に人口になっていても、クエリは余分なジョインを出すでしょう。</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">joinedload</span>

<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                        <span class="n">options</span><span class="p">(</span><span class="n">joinedload</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">addresses</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>                        <span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">one</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password,
        addresses_1.id AS addresses_1_id,
        addresses_1.email_address AS addresses_1_email_address,
        addresses_1.user_id AS addresses_1_user_id
FROM users
    LEFT OUTER JOIN addresses AS addresses_1 ON users.id = addresses_1.user_id
WHERE users.name = ? ORDER BY addresses_1.id
(&#39;jack&#39;,)

</div><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span><span class="o">.</span><span class="n">addresses</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span></pre></div>
</div>
<p>OUTER JOINの結果は2行であったにもかかわらず、「User」のインスタンスが1つしか戻っていないことに注意してください。これは、以下の理由によるものです。class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Query`は、返されたエンティティにオブジェクトアイデンティティに基づいた&amp;quot;ユニーク&amp;quot;戦略を適用します。これは具体的には、照会結果に影響を与えることなく結合されたeagerのロードを適用できるようにするためです。</p>
<p>while：func： <cite>.joinedload`は長い間存在していました：func：</cite> .subqueryload`は熱心な読み込みの新しい形式です。 ：func： <cite>.subqueryload`は、関連するコレクションのロードに適している傾向があります。func：</cite> .joinedload`は多対1の関係に適している傾向があります。リードと関連オブジェクト</p>
<div class="topic">
<p class="topic-title first"><code class="docutils literal notranslate"><span class="pre">joinedload()</span></code> is not a replacement for <code class="docutils literal notranslate"><span class="pre">join()</span></code></p>
<p>作成者：func： <cite>.joinedload`は匿名でエイリアス化されているため、クエリ結果**には影響しません。 An：meth： `.Query.order_by`または：meth：</cite> .Query.filter`呼び出し**はこれらのエイリアステーブルを参照できません - いわゆる &amp;quot;user space&amp;quot;結合は：meth： <cite>.Query .join</cite>。 func： <a href="#id1"><span class="problematic" id="id2">`</span></a>.joinedload`は、関連するオブジェクトやコレクションがどのように最適化の詳細としてロードされるかに影響を与えるためにのみ適用されます。実際の結果に影響を与えずに追加または削除することができます。これがどのように使用されるかの詳細な説明については、ref： <a href="#id3"><span class="problematic" id="id4">`</span></a>zen_of_eager_loading`を参照してください。</p>
</div>
</div>
<div class="section" id="explicit-join-eagerload">
<h3>明示的な結合+ Eagerload<a class="headerlink" href="#explicit-join-eagerload" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>熱心な読み込みの第3のスタイルは、プライマリ・ローの位置を特定するためにJOINを明示的に作成しており、追加のテーブルをプライマリ・オブジェクトの関連するオブジェクトまたはコレクションに追加的に適用する場合です。この機能は：func： <cite>.orm.contains_eager`関数を介して提供され、同じオブジェクトをフィルタリングする必要があるクエリで多対一オブジェクトをあらかじめ読み込む場合に最も便利です。以下では、 `</cite> Address`行と関連する `` User``オブジェクトをロードし、&amp;quot;jack &amp;quot;という名前の &amp;quot;User&amp;quot;をフィルタリングし、：func： <cite>.orm.contains_eager`を使って&amp;quot;user &amp;quot;カラムを `</cite> Address.user``属性に追加します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="kn">from</span> <span class="nn">sqlalchemy.orm</span> <span class="kn">import</span> <span class="n">contains_eager</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">jacks_addresses</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                             <span class="n">join</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                             <span class="nb">filter</span><span class="p">(</span><span class="n">User</span><span class="o">.</span><span class="n">name</span><span class="o">==</span><span class="s1">&#39;jack&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                             <span class="n">options</span><span class="p">(</span><span class="n">contains_eager</span><span class="p">(</span><span class="n">Address</span><span class="o">.</span><span class="n">user</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>                             <span class="nb">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password,
        addresses.id AS addresses_id,
        addresses.email_address AS addresses_email_address,
        addresses.user_id AS addresses_user_id
FROM addresses JOIN users ON users.id = addresses.user_id
WHERE users.name = ?
(&#39;jack&#39;,)

</div><span class="o">&gt;&gt;&gt;</span> <span class="n">jacks_addresses</span>
<span class="p">[</span><span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">Address</span><span class="p">(</span><span class="n">email_address</span><span class="o">=</span><span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">]</span>

<span class="o">&gt;&gt;&gt;</span> <span class="n">jacks_addresses</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">user</span>
<span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Jack Bean&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;gjffdd&#39;</span><span class="p">)</span><span class="o">&gt;</span></pre></div>
</div>
<p>さまざまな形式の読み込みをデフォルトで設定する方法など、熱心な読み込みの詳細については、doc： <a href="#id1"><span class="problematic" id="id2">`</span></a>/ orm / loading_relationships`節を参照してください。</p>
</div>
</div>
<div class="section" id="deleting">
<h2>削除<a class="headerlink" href="#deleting" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>`` jack``を削除し、それがどうなるか見てみましょう。セッションでオブジェクトを削除済みとしてマークし、 `` count``クエリを発行して行が残っていないことを確認します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">jack</span><span class="p">)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<div class='popup_sql'>UPDATE addresses SET user_id=? WHERE addresses.id = ?
((None, 1), (None, 2))
DELETE FROM users WHERE users.id = ?
(5,)
SELECT count(*) AS count_1
FROM (SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name = ?) AS anon_1
(&#39;jack&#39;,)
</div><span class="mi">0</span></pre></div>
</div>
<p>ここまでは順調ですね。 Jackの `` Address``オブジェクトはどうですか？</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">,</span> <span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">])</span>
<span class="o">...</span>  <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<div class='popup_sql'>SELECT count(*) AS count_1
FROM (SELECT addresses.id AS addresses_id,
                addresses.email_address AS addresses_email_address,
                addresses.user_id AS addresses_user_id
FROM addresses
WHERE addresses.email_address IN (?, ?)) AS anon_1
(&#39;jack@google.com&#39;, &#39;j25@yahoo.com&#39;)
</div><span class="mi">2</span></pre></div>
</div>
<p>ああ、彼らはまだそこにいる！フラッシュSQLを分析すると、各アドレスの `` user_id``カラムがNULLに設定されていても、ローは削除されていないことがわかります。 SQLAlchemyはカスケードを削除するとは想定していません。</p>
<div class="section" id="configuring-delete-delete-orphan-cascade">
<span id="tutorial-delete-cascade"></span><h3>delete / delete-orphanカスケードの設定<a class="headerlink" href="#configuring-delete-delete-orphan-cascade" title="このヘッドラインへのパーマリンク">¶</a></h3>
<p>動作を変更するには、 `` User.addresses``関係に**カスケード**オプションを設定します。 SQLAlchemyでは任意の時点でマッピングに新しい属性や関係を追加することができますが、既存の関係を削除する必要があるため、マッピングを完全に解凍してから再開する必要があります。クラス： <cite>.Session</cite></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">session</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="go">ROLLBACK</span></pre></div>
</div>
<p>新しい：func： <cite>.declarative_base</cite> ::を使用してください</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">Base</span> <span class="o">=</span> <span class="n">declarative_base</span><span class="p">()</span></pre></div>
</div>
<p>次に、 `` User``クラスを宣言し、カスケード設定を含む `` addresses``の関係を追加します（私たちはコンストラクタも残します）:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">User</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;users&#39;</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">name</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">fullname</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">password</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="n">addresses</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;Address&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;user&#39;</span><span class="p">,</span>
<span class="gp">... </span>                    <span class="n">cascade</span><span class="o">=</span><span class="s2">&quot;all, delete, delete-orphan&quot;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>       <span class="k">return</span> <span class="s2">&quot;&lt;User(name=&#39;</span><span class="si">%s</span><span class="s2">&#39;, fullname=&#39;</span><span class="si">%s</span><span class="s2">&#39;, password=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&gt;&quot;</span> <span class="o">%</span> <span class="p">(</span>
<span class="gp">... </span>                               <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">fullname</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">password</span><span class="p">)</span></pre></div>
</div>
<p>この場合、 `` User``クラスを介して `` Address.user``関係を既に作成していることに気づいて、 `` Address``を再作成します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Address</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;addresses&#39;</span>
<span class="gp">... </span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">email_address</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">,</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.id&#39;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">user</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s2">&quot;User&quot;</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;addresses&quot;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s2">&quot;&lt;Address(email_address=&#39;</span><span class="si">%s</span><span class="s2">&#39;)&gt;&quot;</span> <span class="o">%</span> <span class="bp">self</span><span class="o">.</span><span class="n">email_address</span></pre></div>
</div>
<p>これで、主キーでロードされる：meth： <cite>〜.Query.get`を使用して、ユーザー</cite> <cite>jack``をロードすると、対応する</cite> <cite>addresses``コレクションからアドレスを削除すると、</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>アドレスは削除されます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="c1"># load Jack by primary key</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">jack</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<div class='popup_sql'>BEGIN (implicit)
SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.id = ?
(5,)
</div>
<span class="c1"># remove one Address (lazy load fires off)</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="k">del</span> <span class="n">jack</span><span class="o">.</span><span class="n">addresses</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<div class='popup_sql'>SELECT addresses.id AS addresses_id,
        addresses.email_address AS addresses_email_address,
        addresses.user_id AS addresses_user_id
FROM addresses
WHERE ? = addresses.user_id
(5,)
</div>
<span class="c1"># only one address remains</span>
<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="o">...</span>     <span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">,</span> <span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">])</span>
<span class="o">...</span> <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<div class='popup_sql'>DELETE FROM addresses WHERE addresses.id = ?
(2,)
SELECT count(*) AS count_1
FROM (SELECT addresses.id AS addresses_id,
                addresses.email_address AS addresses_email_address,
                addresses.user_id AS addresses_user_id
FROM addresses
WHERE addresses.email_address IN (?, ?)) AS anon_1
(&#39;jack@google.com&#39;, &#39;j25@yahoo.com&#39;)
</div><span class="mi">1</span></pre></div>
</div>
<p>Jackを削除すると、Jackとユーザに関連する残りの `` Address``の両方が削除されます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">jack</span><span class="p">)</span>

<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span><span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;jack&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<div class='popup_sql'>DELETE FROM addresses WHERE addresses.id = ?
(1,)
DELETE FROM users WHERE users.id = ?
(5,)
SELECT count(*) AS count_1
FROM (SELECT users.id AS users_id,
                users.name AS users_name,
                users.fullname AS users_fullname,
                users.password AS users_password
FROM users
WHERE users.name = ?) AS anon_1
(&#39;jack&#39;,)
</div><span class="mi">0</span>

<a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">Address</span><span class="p">)</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span>
<span class="o">...</span>    <span class="n">Address</span><span class="o">.</span><span class="n">email_address</span><span class="o">.</span><span class="n">in_</span><span class="p">([</span><span class="s1">&#39;jack@google.com&#39;</span><span class="p">,</span> <span class="s1">&#39;j25@yahoo.com&#39;</span><span class="p">])</span>
<span class="o">...</span> <span class="p">)</span><span class="o">.</span><span class="n">count</span><span class="p">()</span>
<div class='popup_sql'>SELECT count(*) AS count_1
FROM (SELECT addresses.id AS addresses_id,
                addresses.email_address AS addresses_email_address,
                addresses.user_id AS addresses_user_id
FROM addresses
WHERE addresses.email_address IN (?, ?)) AS anon_1
(&#39;jack@google.com&#39;, &#39;j25@yahoo.com&#39;)
</div><span class="mi">0</span></pre></div>
</div>
<div class="topic">
<p class="topic-title first">More on Cascades</p>
<p>カスケードの設定の詳細は：ref： <a href="#id1"><span class="problematic" id="id2">`</span></a>unitofwork_cascades`を参照してください。カスケード機能は、リレーショナルデータベースの &amp;quot;ON DELETE CASCADE&amp;quot;機能とスムーズに統合することもできます。詳細は：ref： <a href="#id3"><span class="problematic" id="id4">`</span></a>passive_deletes`を参照してください。</p>
</div>
</div>
</div>
<div class="section" id="building-a-many-to-many-relationship">
<span id="orm-tutorial-many-to-many"></span><h2>多対多の関係を構築する<a class="headerlink" href="#building-a-many-to-many-relationship" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>ここではボーナスに移行していますが、多対多の関係を誇示することができます。ツアーをするだけで、他の機能も搭載されていきます。私たちのアプリケーションをブログアプリケーションにして、 `` BlogPost``アイテムを書くことができます。そこには `` Keyword``アイテムが関連付けられています。</p>
<p>プレーンの多対多の場合、関連テーブルとして機能するためにマップされていない：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Table`構文を作成する必要があります。これは次のようになります:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">from</span> <span class="nn">sqlalchemy</span> <span class="k">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Text</span>
<span class="gp">&gt;&gt;&gt; </span><span class="c1"># association table</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">post_keywords</span> <span class="o">=</span> <span class="n">Table</span><span class="p">(</span><span class="s1">&#39;post_keywords&#39;</span><span class="p">,</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="p">,</span>
<span class="gp">... </span>    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;post_id&#39;</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;posts.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">),</span>
<span class="gp">... </span>    <span class="n">Column</span><span class="p">(</span><span class="s1">&#39;keyword_id&#39;</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;keywords.id&#39;</span><span class="p">),</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span><span class="p">)</span></pre></div>
</div>
<p>上記のように、class： <cite>.Table`を直接宣言することは、マップされたクラスを宣言することとは少し異なります。 ：class： `.Table`はコンストラクタ関数なので、class：</cite> .Column`引数はカンマで区切られています。 ：class： <a href="#id1"><span class="problematic" id="id2">`</span></a>.Column`オブジェクトには、割り当てられた属性名から取り出されるのではなく、その名前が明示的に与えられます。</p>
<p>次に、 `` BlogPost``と `` Keyword``を、それぞれ `` post_keywords``テーブルを関連テーブルとして参照する、complement：func： <a href="#id1"><span class="problematic" id="id2">`</span></a>.relationship`構造体を使って定義します:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">BlogPost</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;posts&#39;</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">user_id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">ForeignKey</span><span class="p">(</span><span class="s1">&#39;users.id&#39;</span><span class="p">))</span>
<span class="gp">... </span>    <span class="n">headline</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">255</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">body</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Text</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="c1"># many to many BlogPost&lt;-&gt;Keyword</span>
<span class="gp">... </span>    <span class="n">keywords</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;Keyword&#39;</span><span class="p">,</span>
<span class="gp">... </span>                            <span class="n">secondary</span><span class="o">=</span><span class="n">post_keywords</span><span class="p">,</span>
<span class="gp">... </span>                            <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;posts&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">headline</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">author</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">author</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">headline</span> <span class="o">=</span> <span class="n">headline</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">body</span> <span class="o">=</span> <span class="n">body</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="gp">... </span>        <span class="k">return</span> <span class="s2">&quot;BlogPost(</span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">, </span><span class="si">%r</span><span class="s2">)&quot;</span> <span class="o">%</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">headline</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">body</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">author</span><span class="p">)</span>


<span class="gp">&gt;&gt;&gt; </span><span class="k">class</span> <span class="nc">Keyword</span><span class="p">(</span><span class="n">Base</span><span class="p">):</span>
<span class="gp">... </span>    <span class="n">__tablename__</span> <span class="o">=</span> <span class="s1">&#39;keywords&#39;</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="nb">id</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">Integer</span><span class="p">,</span> <span class="n">primary_key</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">keyword</span> <span class="o">=</span> <span class="n">Column</span><span class="p">(</span><span class="n">String</span><span class="p">(</span><span class="mi">50</span><span class="p">),</span> <span class="n">nullable</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="gp">... </span>    <span class="n">posts</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="s1">&#39;BlogPost&#39;</span><span class="p">,</span>
<span class="gp">... </span>                         <span class="n">secondary</span><span class="o">=</span><span class="n">post_keywords</span><span class="p">,</span>
<span class="gp">... </span>                         <span class="n">back_populates</span><span class="o">=</span><span class="s1">&#39;keywords&#39;</span><span class="p">)</span>
<span class="gp">...</span>
<span class="gp">... </span>    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">keyword</span><span class="p">):</span>
<span class="gp">... </span>        <span class="bp">self</span><span class="o">.</span><span class="n">keyword</span> <span class="o">=</span> <span class="n">keyword</span></pre></div>
</div>
<div class="admonition note">
<p class="first admonition-title">注釈</p>
<p class="last">上記のクラス宣言は明示的な `` __init __（） <a href="#id1"><span class="problematic" id="id2">``</span></a>メソッドを示しています。 Declarativeを使用するときは、オプションであることを覚えておいてください。</p>
</div>
<p>上記の多対多の関係は `` BlogPost.keywords``です。多対多関係の定義的な特徴は、関連テーブルを表す <cite>：sqlalchemy.schema.Table`オブジェクトを参照する</cite> <a href="#id1"><span class="problematic" id="id2">`</span></a>secondary``キーワード引数です。この表には、関係の2つの側面を参照する列のみが含まれています。それ自身のプライマリキーや他のテーブルへの外部キーなど* <a href="#id3"><span class="problematic" id="id4">*</span></a>の他のカラムがある場合、SQLAlchemyは：ref： <a href="#id5"><span class="problematic" id="id6">`</span></a>association_pattern`で説明されている&amp;quot;関連オブジェクト&amp;quot;という別の使用パターンを必要とします。</p>
<p>私たちの `` BlogPost``クラスも `` author``フィールドを持っているといいでしょう。これを別の双方向関係として追加しますが、1つのユーザーには1人のユーザーが多数のブログ投稿を持っている可能性があります。 `` User.posts``にアクセスすると、結果をさらに絞り込み、コレクション全体を読み込まないようにしたいと考えています。このためには、属性に別の**ローダー戦略**を設定する、 `` lazy = &amp;#39;dynamic```と呼ばれる：func： <a href="#id1"><span class="problematic" id="id2">`</span></a>〜sqlalchemy.orm.relationship`によって受け入れられる設定を使用します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">User</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;posts&quot;</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">User</span><span class="o">.</span><span class="n">posts</span> <span class="o">=</span> <span class="n">relationship</span><span class="p">(</span><span class="n">BlogPost</span><span class="p">,</span> <span class="n">back_populates</span><span class="o">=</span><span class="s2">&quot;author&quot;</span><span class="p">,</span> <span class="n">lazy</span><span class="o">=</span><span class="s2">&quot;dynamic&quot;</span><span class="p">)</span></pre></div>
</div>
<p>新しいテーブルを作成する：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">Base</span><span class="o">.</span><span class="n">metadata</span><span class="o">.</span><span class="n">create_all</span><span class="p">(</span><span class="n">engine</span><span class="p">)</span>
<div class='popup_sql'>PRAGMA...
CREATE TABLE keywords (
    id INTEGER NOT NULL,
    keyword VARCHAR(50) NOT NULL,
    PRIMARY KEY (id),
    UNIQUE (keyword)
)
()
COMMIT
CREATE TABLE posts (
    id INTEGER NOT NULL,
    user_id INTEGER,
    headline VARCHAR(255) NOT NULL,
    body TEXT,
    PRIMARY KEY (id),
    FOREIGN KEY(user_id) REFERENCES users (id)
)
()
COMMIT
CREATE TABLE post_keywords (
    post_id INTEGER NOT NULL,
    keyword_id INTEGER NOT NULL,
    PRIMARY KEY (post_id, keyword_id),
    FOREIGN KEY(post_id) REFERENCES posts (id),
    FOREIGN KEY(keyword_id) REFERENCES keywords (id)
)
()
COMMIT</div></pre></div>
</div>
<p>使い方は私たちが行ってきたこととあまり変わらない。 Wendyにいくつかのブログ記事を出しましょう：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">wendy</span> <span class="o">=</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">User</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                 <span class="n">filter_by</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>                 <span class="n">one</span><span class="p">()</span>
<div class='popup_sql'>SELECT users.id AS users_id,
        users.name AS users_name,
        users.fullname AS users_fullname,
        users.password AS users_password
FROM users
WHERE users.name = ?
(&#39;wendy&#39;,)
</div><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span> <span class="o">=</span> <span class="n">BlogPost</span><span class="p">(</span><span class="s2">&quot;Wendy&#39;s Blog Post&quot;</span><span class="p">,</span> <span class="s2">&quot;This is a test&quot;</span><span class="p">,</span> <span class="n">wendy</span><span class="p">)</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">post</span><span class="p">)</span></pre></div>
</div>
<p>キーワードはデータベースに一意に格納されていますが、まだ作成されていないことがわかっているので、作成することができます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Keyword</span><span class="p">(</span><span class="s1">&#39;wendy&#39;</span><span class="p">))</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">post</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Keyword</span><span class="p">(</span><span class="s1">&#39;firstpost&#39;</span><span class="p">))</span></pre></div>
</div>
<p>キーワードfirstpostを使ってすべてのブログ記事を検索できるようになりました。 `` any``演算子を使用してキーワードの文字列が &amp;#39;firstpost&amp;#39; &amp;quot;のブログ記事を検索します：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BlogPost</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>             <span class="nb">filter</span><span class="p">(</span><span class="n">BlogPost</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;firstpost&#39;</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>             <span class="nb">all</span><span class="p">()</span>
<div class='popup_sql'>INSERT INTO keywords (keyword) VALUES (?)
(&#39;wendy&#39;,)
INSERT INTO keywords (keyword) VALUES (?)
(&#39;firstpost&#39;,)
INSERT INTO posts (user_id, headline, body) VALUES (?, ?, ?)
(2, &#34;Wendy&#39;s Blog Post&#34;, &#39;This is a test&#39;)
INSERT INTO post_keywords (post_id, keyword_id) VALUES (?, ?)
(...)
SELECT posts.id AS posts_id,
        posts.user_id AS posts_user_id,
        posts.headline AS posts_headline,
        posts.body AS posts_body
FROM posts
WHERE EXISTS (SELECT 1
    FROM post_keywords, keywords
    WHERE posts.id = post_keywords.post_id
        AND keywords.id = post_keywords.keyword_id
        AND keywords.keyword = ?)
(&#39;firstpost&#39;,)
</div><span class="p">[</span><span class="n">BlogPost</span><span class="p">(</span><span class="s2">&quot;Wendy&#39;s Blog Post&quot;</span><span class="p">,</span> <span class="s1">&#39;This is a test&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)]</span></pre></div>
</div>
<p>ユーザが所有する投稿を検索したい場合、そのユーザに親としてのクエリを絞り込むことができます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">session</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="n">BlogPost</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>             <span class="nb">filter</span><span class="p">(</span><span class="n">BlogPost</span><span class="o">.</span><span class="n">author</span><span class="o">==</span><span class="n">wendy</span><span class="p">)</span><span class="o">.</span>\
<span class="o">...</span>             <span class="nb">filter</span><span class="p">(</span><span class="n">BlogPost</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;firstpost&#39;</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>             <span class="nb">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT posts.id AS posts_id,
        posts.user_id AS posts_user_id,
        posts.headline AS posts_headline,
        posts.body AS posts_body
FROM posts
WHERE ? = posts.user_id AND (EXISTS (SELECT 1
    FROM post_keywords, keywords
    WHERE posts.id = post_keywords.post_id
        AND keywords.id = post_keywords.keyword_id
        AND keywords.keyword = ?))
(2, &#39;firstpost&#39;)
</div><span class="p">[</span><span class="n">BlogPost</span><span class="p">(</span><span class="s2">&quot;Wendy&#39;s Blog Post&quot;</span><span class="p">,</span> <span class="s1">&#39;This is a test&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)]</span></pre></div>
</div>
<p>あるいは、Wendy自身の `` posts``関係を&amp;quot;動的&amp;quot;関係で使用して、そこから直接問い合わせることができます：</p>
<div class="highlight-python+sql notranslate"><div class="highlight"><pre><span></span><a href='#' class='sql_link'>sql</a><span class="o">&gt;&gt;&gt;</span> <span class="n">wendy</span><span class="o">.</span><span class="n">posts</span><span class="o">.</span>\
<span class="o">...</span>         <span class="nb">filter</span><span class="p">(</span><span class="n">BlogPost</span><span class="o">.</span><span class="n">keywords</span><span class="o">.</span><span class="n">any</span><span class="p">(</span><span class="n">keyword</span><span class="o">=</span><span class="s1">&#39;firstpost&#39;</span><span class="p">))</span><span class="o">.</span>\
<span class="o">...</span>         <span class="nb">all</span><span class="p">()</span>
<div class='popup_sql'>SELECT posts.id AS posts_id,
        posts.user_id AS posts_user_id,
        posts.headline AS posts_headline,
        posts.body AS posts_body
FROM posts
WHERE ? = posts.user_id AND (EXISTS (SELECT 1
    FROM post_keywords, keywords
    WHERE posts.id = post_keywords.post_id
        AND keywords.id = post_keywords.keyword_id
        AND keywords.keyword = ?))
(2, &#39;firstpost&#39;)
</div><span class="p">[</span><span class="n">BlogPost</span><span class="p">(</span><span class="s2">&quot;Wendy&#39;s Blog Post&quot;</span><span class="p">,</span> <span class="s1">&#39;This is a test&#39;</span><span class="p">,</span> <span class="o">&lt;</span><span class="n">User</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s1">&#39;wendy&#39;</span><span class="p">,</span> <span class="n">fullname</span><span class="o">=</span><span class="s1">&#39;Wendy Williams&#39;</span><span class="p">,</span> <span class="n">password</span><span class="o">=</span><span class="s1">&#39;foobar&#39;</span><span class="p">)</span><span class="o">&gt;</span><span class="p">)]</span></pre></div>
</div>
</div>
<div class="section" id="further-reference">
<h2>さらなる参照<a class="headerlink" href="#further-reference" title="このヘッドラインへのパーマリンク">¶</a></h2>
<p>クエリリファレンス：：ref： <cite>query_api_toplevel</cite></p>
<p>マッパーリファレンス：：ref： <cite>mapper_config_toplevel</cite></p>
<p>関係リファレンス：：ref： <cite>relationship_config_toplevel</cite></p>
<p>セッションリファレンス：：doc： <cite>/ orm / session</cite></p>
</div>
</div>

    </div>

</div>

<div id="docs-bottom-navigation" class="docs-navigation-links, withsidebar">
        Previous:
        <a href="index.html" title="previous chapter">SQLAlchemy ORM</a>
        Next:
        <a href="mapper_config.html" title="next chapter">マッパー設定</a>

    <div id="docs-copyright">
        &copy; <a href="../copyright.html">Copyright</a> 2007-2018, the SQLAlchemy authors and contributors.
        Created using <a href="http://sphinx.pocoo.org/">Sphinx</a> 1.8.1.
    </div>
</div>

</div>



        
        

    <script type="text/javascript">
      var DOCUMENTATION_OPTIONS = {
          URL_ROOT:    '../',
          VERSION:     '1.3.0b1',
          COLLAPSE_MODINDEX: false,
          FILE_SUFFIX: '.html'
      };
    </script>

    <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>

    <!-- begin iterate through sphinx environment script_files -->
        <script type="text/javascript" src="../_static/jquery.js"></script>
        <script type="text/javascript" src="../_static/underscore.js"></script>
        <script type="text/javascript" src="../_static/doctools.js"></script>
        <script type="text/javascript" src="../_static/translations.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
    <!-- end iterate through sphinx environment script_files -->

    <script type="text/javascript" src="../_static/detectmobile.js"></script>
    <script type="text/javascript" src="../_static/init.js"></script>


    </body>
</html>


